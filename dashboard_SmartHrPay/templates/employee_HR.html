<!DOCTYPE html>
<html lang="vi">
{% extends "base.html" %}

{% block title %}Quản Lý Nhân Viên{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='employee_HR.css') }}" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    
{% endblock %}

{% block header %}
    Quản Lý Nhân Viên
{% endblock %}

{% block content %}
    <div class="employee-table">
        <div class="table-header">
            <div class="search-container">
                <input
                    type="text"
                    class="search-bar"
                    id="searchInput"
                    placeholder="Tìm kiếm nhân viên..."
                />
                <button class="search-btn" onclick="searchEmployees()">
                    Tìm kiếm
                </button>
            </div>
            <button class="add-btn" onclick="openAddModal()">
                Thêm Nhân Viên
            </button>
        </div>
        <table id="employee-table">
            <thead>
                <tr>
                    <th>Mã Nhân Viên</th>
                    <th>Họ</th>
                    <th>Tên</th>
                    <th>Công việc</th>
                    <th>Phòng Ban</th>
                    <th>Email</th>
                    <th>Ngày Vào Làm</th>
                    <th>Lương Cơ Bản</th>
                    <th>Trạng Thái</th>
                    <th>Hành Động</th>
                </tr>
            </thead>
            <tbody id="employeeBody">
                {% for employee in employees %}
                <tr>
                    <td>{{ employee.employee_id }}</td>
                    <td>{{ employee.last_name }}</td>
                    <td>{{ employee.first_name }}</td>
                    <td>{{ employee.job_title }}</td>
                    <td>{{ employee.department_name }}</td>
                    <td>{{ employee.email }}</td>
                    <td>{{ employee.hire_date }}</td>
                    <td>{{ employee.base_salary }}</td>
                    <td>{{ employee.status }}</td>
                    <td>
                        <button class="action-btn view-btn" onclick="viewEmployee('{{ employee.employee_id }}')">Xem</button>
                        <button class="action-btn detail-btn" onclick="showEmployeeDetail('{{ employee.employee_id }}')">Chi tiết</button>
                        <form method="POST" action="{{ url_for('delete_employee', id=employee.employee_id) }}" style="display:inline;" onsubmit="return confirm('Bạn có chắc chắn muốn xóa nhân viên {{ employee.employee_id }}?');">
                            <button type="submit" class="action-btn delete-btn">Xóa</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Modal Thêm Nhân Viên -->
    <div id="addEmployeeModal" class="modal">
        <div class="modal-content">
            <h2>Thêm Nhân Viên</h2>
            <form id="addEmployeeForm" method="POST" action="{{ url_for('add_employee') }}">
                <label for="firstName">Tên:</label>
                <input type="text" id="firstName" name="first_name" required />

                <label for="lastName">Họ:</label>
                <input type="text" id="lastName" name="last_name" required />

                <label for="email">Email:</label>
                <input type="email" id="email" name="email" required />

                <label for="phone">Số điện thoại:</label>
                <input type="tel" id="phone" name="phone" required />

                <label for="jobTitle">Công việc:</label>
                <input type="text" id="jobTitle" name="job_title" required />

                <label for="departmentName">Phòng ban:</label>
                <input type="text" id="departmentName" name="department_name" required />

                <label for="hireDate">Ngày vào làm:</label>
                <input type="date" id="hireDate" name="hire_date" required />

                <label for="baseSalary">Lương cơ bản (VNĐ):</label>
                <input type="number" id="baseSalary" name="base_salary" required />

                <div class="modal-buttons">
                    <button type="button" class="cancel-btn" onclick="closeAddModal()">Hủy</button>
                    <button type="submit" class="save-btn">Lưu</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Xem Thông Tin Nhân Viên -->
    <div id="viewEmployeeModal" class="modal">
        <div class="modal-content">
            <h2>Thông Tin Nhân Viên</h2>
            <table id="employeeDetailsTable">
                <tr>
                    <th>Mã Nhân Viên</th>
                    <td><input type="text" id="editEmployeeIdDisplay" disabled /></td>
                </tr>
                <tr>
                    <th>Họ</th>
                    <td><input type="text" id="editLastName" disabled /></td>
                </tr>
                <tr>
                    <th>Tên</th>
                    <td><input type="text" id="editFirstName" disabled /></td>
                </tr>
                <tr>
                    <th>Email</th>
                    <td><input type="email" id="editEmail" disabled /></td>
                </tr>
                <tr>
                    <th>Số điện thoại</th>
                    <td><input type="tel" id="editPhone" disabled /></td>
                </tr>
                <tr>
                    <th>Ngày vào làm</th>
                    <td><input type="date" id="editHireDate" disabled /></td>
                </tr>
                <tr>
                    <th>Phòng ban</th>
                    <td><input type="text" id="editDepartmentName" disabled /></td>
                </tr>
                <tr>
                    <th>Công việc</th>
                    <td><input type="text" id="editJobTitle" disabled /></td>
                </tr>
                <tr>
                    <th>Lương cơ bản</th>
                    <td><input type="number" id="editBaseSalary" disabled /></td>
                </tr>
                <tr>
                    <th>Trạng thái</th>
                    <td>
                        <select id="editStatus" disabled>
                            <option value="Đang làm việc">Đang làm việc</option>
                            <option value="Nghỉ việc">Nghỉ việc</option>
                        </select>
                    </td>
                </tr>
            </table>
            <div class="modal-buttons">
                <button type="button" class="action-btn close-btn" onclick="closeViewModal()">Thoát</button>
            </div>
        </div>
    </div>

    <!-- Modal Chi Tiết Nhân Viên -->
    <div id="employeeDetailModal" class="modal">
        <div class="modal-content">
            <h2>Chi tiết nhân viên</h2>
            <div class="employee-detail-section">
                <h4>Thông tin cá nhân</h4>
                <p><strong>Mã nhân viên:</strong> <span id="detailEmployeeId"></span></p>
                <p><strong>Họ tên:</strong> <span id="detailFullName"></span></p>
                <p><strong>Giới tính:</strong> <span id="detailGender"></span></p>
                <p><strong>Ngày sinh:</strong> <span id="detailDOB"></span></p>
                <p><strong>Địa chỉ:</strong> <span id="detailAddress"></span></p>
                <p><strong>Email:</strong> <span id="detailEmail"></span></p>
                <p><strong>Số điện thoại:</strong> <span id="detailPhone"></span></p>
            </div>
            <div class="employee-detail-section">
                <h4>Thông tin công việc</h4>
                <p><strong>Chức vụ:</strong> <span id="detailPosition"></span></p>
                <p><strong>Phòng ban:</strong> <span id="detailDepartment"></span></p>
                <p><strong>Ngày vào làm:</strong> <span id="detailHireDate"></span></p>
                <p><strong>Ca làm việc:</strong> <span id="detailWorkShift"></span></p>
                <p><strong>Loại hợp đồng:</strong> <span id="detailContractType"></span></p>
                <p><strong>Trạng thái:</strong> <span id="detailStatus"></span></p>
            </div>
            <div class="employee-detail-section">
                <h4>Lương và phụ cấp</h4>
                <p><strong>Lương cơ bản:</strong> <span id="detailBaseSalary"></span> VNĐ</p>
                <p><strong>Tiền thưởng:</strong> <span id="detailBonus"></span> VNĐ</p>
                <p><strong>Khoản khấu trừ:</strong> <span id="detailDeductions"></span> VNĐ</p>
                <p><strong>Lương thực lĩnh:</strong> <span id="detailNetSalary"></span> VNĐ</p>
            </div>
            <div class="detail-actions">
                <button class="btn btn-warning" onclick="viewEmployee(currentEmployeeId)">Xem thông tin</button>
                <form method="POST" action="" style="display:inline;" onsubmit="return confirm('Bạn có chắc chắn muốn xóa nhân viên?');">
                    <input type="hidden" id="deleteEmployeeId" name="employee_id">
                    <button type="submit" class="btn btn-danger">Xóa nhân viên</button>
                </form>
                <button class="btn btn-secondary" onclick="closeDetailModal()">Đóng</button>
            </div>
        </div>
    </div>

    <script>
        // Store employees data for client-side operations
        const employees = {{ employees | tojson }};
        let currentEmployeeId = null;

        function openAddModal() {
            document.getElementById("addEmployeeModal").style.display = "flex";
        }

        function closeAddModal() {
            document.getElementById("addEmployeeModal").style.display = "none";
            document.getElementById("addEmployeeForm").reset();
        }

        function viewEmployee(employeeId) {
            const employee = employees.find(emp => emp.employee_id == employeeId);
            if (employee) {
                document.getElementById("editEmployeeIdDisplay").value = employee.employee_id;
                document.getElementById("editLastName").value = employee.last_name;
                document.getElementById("editFirstName").value = employee.first_name;
                document.getElementById("editEmail").value = employee.email;
                document.getElementById("editPhone").value = employee.phone;
                document.getElementById("editHireDate").value = employee.hire_date;
                document.getElementById("editDepartmentName").value = employee.department_name;
                document.getElementById("editJobTitle").value = employee.job_title;
                document.getElementById("editBaseSalary").value = employee.base_salary;
                document.getElementById("editStatus").value = employee.status;

                closeDetailModal();
                document.getElementById("viewEmployeeModal").style.display = "flex";
            }
        }

        function closeViewModal() {
            document.getElementById("viewEmployeeModal").style.display = "none";
        }

        function showEmployeeDetail(employeeId) {
            const employee = employees.find(emp => emp.employee_id == employeeId);
            if (employee) {
                currentEmployeeId = employeeId;
                document.getElementById("detailEmployeeId").textContent = employee.employee_id;
                document.getElementById("detailFullName").textContent = employee.full_name;
                document.getElementById("detailGender").textContent = "Chưa cập nhật";
                document.getElementById("detailDOB").textContent = "Chưa cập nhật";
                document.getElementById("detailAddress").textContent = "Chưa cập nhật";
                document.getElementById("detailEmail").textContent = employee.email;
                document.getElementById("detailPhone").textContent = employee.phone;
                document.getElementById("detailPosition").textContent = employee.job_title;
                document.getElementById("detailDepartment").textContent = employee.department_name;
                document.getElementById("detailHireDate").textContent = employee.hire_date;
                document.getElementById("detailWorkShift").textContent = "Giờ hành chính";
                document.getElementById("detailContractType").textContent = "Hợp đồng dài hạn";
                document.getElementById("detailStatus").textContent = employee.status;
                document.getElementById("detailBaseSalary").textContent = employee.base_salary.toLocaleString();
                document.getElementById("detailBonus").textContent = employee.bonus.toLocaleString();
                document.getElementById("detailDeductions").textContent = employee.deductions.toLocaleString();
                const netSalary = employee.base_salary + employee.bonus - employee.deductions;
                document.getElementById("detailNetSalary").textContent = netSalary.toLocaleString();
                document.getElementById("deleteEmployeeId").value = employeeId;

                const deleteForm = document.querySelector("#employeeDetailModal form");
                deleteForm.action = `/employees/${employeeId}`;

                closeViewModal();
                document.getElementById("employeeDetailModal").style.display = "flex";
            }
        }

        function closeDetailModal() {
            document.getElementById("employeeDetailModal").style.display = "none";
            currentEmployeeId = null;
        }

        function searchEmployees() {
            const input = document.getElementById("searchInput").value.toLowerCase();
            const rows = document.querySelectorAll("#employeeBody tr");
            rows.forEach((row) => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(input) ? "" : "none";
            });
        }
    </script>
{% endblock %}
</html>
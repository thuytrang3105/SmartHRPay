<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Employee Dashboard</title>
    <link rel="stylesheet" href="/static/home_nv.css" />
  </head>
  <body>
    <header class="header">
      <h2>Employee Dashboard</h2>
      <div class="user-info">
        <span class="profile">A</span>
        <div class="logout-container">
          <a href="{{ url_for('logout') }}"><i>üö™</i> ƒêƒÉng xu·∫•t</a>
        </div>
      </div>
    </header>

    <div class="content-box">
      <h3>Th√¥ng tin c√° nh√¢n</h3>
      <table border="1">
        <tr>
          <th>Thu·ªôc t√≠nh</th>
          <th>Gi√° tr·ªã</th>
        </tr>
        <tr>
          <td>ID</td>
          <td>{{ employee.employee_id }}</td>
        </tr>
        <tr>
          <td>H·ªç</td>
          <td>{{ employee.last_name }}</td>
        </tr>
        <tr>
          <td>T√™n</td>
          <td>{{ employee.first_name }}</td>
        </tr>
        <tr>
          <td>Email</td>
          <td>{{ employee.email }}</td>
        </tr>
        <tr>
          <td>ƒêi·ªán tho·∫°i</td>
          <td>{{ employee.phone }}</td>
        </tr>
        <tr>
          <td>Ng√†y v√†o l√†m</td>
          <td>{{ employee.start_date }}</td>
        </tr>
        <tr>
          <td>Ph√≤ng ban</td>
          <td>{{ employee.department_name }}</td>
        </tr>
        <tr>
          <td>C√¥ng vi·ªác</td>
          <td>{{ employee.job_title }}</td>
        </tr>
        <tr>
          <td>Tr·∫°ng th√°i</td>
          <td>{{ employee.status }}</td>
        </tr>
      </table>
    </div>

    <div class="main-content">
      <div class="tabs">
        <button class="tab-btn" onclick="showTab('notifications')">
          Th√¥ng b√°o
        </button>
        <button class="tab-btn" onclick="showTab('salary')">B·∫£ng l∆∞∆°ng</button>
        <button class="tab-btn" onclick="showTab('attendance')">
          Ng√†y c√¥ng
        </button>
      </div>

      <div id="notifications" class="content-box" style="display: block">
        {% if notifications %} {% for notification in notifications %}
        <div class="notification">
          <h3>{{ notification.title }}</h3>
          <p>{{ notification.content }}</p>
          <p><small>{{ notification.timestamp }}</small></p>
        </div>
        {% endfor %} {% else %}
        <p>Ch∆∞a c√≥ th√¥ng b√°o n√†o.</p>
        {% endif %}
      </div>

      <div id="salary" class="content-box" style="display: none">
        <h3>Ch·ªçn th√°ng/nƒÉm ƒë·ªÉ xem b·∫£ng l∆∞∆°ng</h3>
        <label>
          Th√°ng:
          <select id="month">
            <script>
              for (let i = 1; i <= 12; i++) {
                document.write(`<option value="${i}">${i}</option>`);
              }
            </script>
          </select>
        </label>
        <label>
          NƒÉm:
          <select id="year">
            <script>
              let currentYear = new Date().getFullYear();
              for (let i = currentYear - 5; i <= currentYear; i++) {
                document.write(`<option value="${i}">${i}</option>`);
              }
            </script>
          </select>
        </label>
        <button onclick="showSalary()">Xem l∆∞∆°ng</button>

        <div id="salaryTable">
          <h3>
            B·∫£ng l∆∞∆°ng th√°ng
            <span id="selectedMonth">{{ selected_month }}</span>/<span
              id="selectedYear"
              >{{ selected_year }}</span
            >
          </h3>
          <table border="1">
            <tr>
              <th>Thu·ªôc t√≠nh</th>
              <th>Gi√° tr·ªã</th>
            </tr>
            <tr>
              <td>L∆∞∆°ng c∆° b·∫£n</td>
              <td id="baseSalary">{{ salary.base_salary }}</td>
            </tr>
            <tr>
              <td>Th∆∞·ªüng</td>
              <td id="bonus">{{ salary.bonus }}</td>
            </tr>
            <tr>
              <td>Ng√†y c√¥ng</td>
              <td id="present">{{ salary.present }}</td>
            </tr>
            <tr>
              <td>S·ªë ng√†y ngh·ªâ ph√©p</td>
              <td id="absent">{{ salary.absent }}</td>
            </tr>
            <tr>
              <td>S·ªë ng√†y v·∫Øng</td>
              <td id="leave">{{ salary.leave }}</td>
            </tr>
            <tr>
              <td>Kh·∫•u tr·ª´</td>
              <td id="deductions">{{ salary.deductions }}</td>
            </tr>
            <tr>
              <td><b>T·ªïng l∆∞∆°ng</b></td>
              <td id="netSalary"><b>{{ salary.net_salary }}</b></td>
            </tr>
          </table>
          <p id="errorMessage" style="color: red; display: none"></p>
        </div>
      </div>

      <div id="attendance" class="content-box" style="display: none">
        <h3>Ng√†y c√¥ng</h3>
        <table id="attendanceTable" border="1">
          <thead>
            <tr>
              <th>Ng√†y</th>
              <th>Tr·∫°ng th√°i</th>
            </tr>
          </thead>
          <tbody>
            <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
          </tbody>
        </table>
        <p id="attendanceError" style="color: red; display: none"></p>
      </div>
    </div>

    <div class="timekeeping">
      <h3>Ch·∫•m c√¥ng</h3>
      <button class="check-in" onclick="checkIn()">Check-in</button>
      <button class="check-out" onclick="checkOut()">Check-out</button>
      <p id="status">Ch∆∞a check-in</p>
    </div>

    <script>
      function showTab(tab) {
        document.getElementById("notifications").style.display =
          tab === "notifications" ? "block" : "none";
        document.getElementById("salary").style.display =
          tab === "salary" ? "block" : "none";
        document.getElementById("attendance").style.display =
          tab === "attendance" ? "block" : "none";

        if (tab === "attendance") {
          loadAttendanceData();
        }
      }

      async function showSalary() {
        const month = document.getElementById("month").value;
        const year = document.getElementById("year").value;
        const salaryTable = document.getElementById("salaryTable");
        const errorMessage = document.getElementById("errorMessage");

        salaryTable.style.display = "none";
        errorMessage.style.display = "none";
        errorMessage.textContent = "";

        try {
          const response = await fetch(
            `/api/salary?month=${month}&year=${year}`
          );
          if (!response.ok) {
            throw new Error(
              `Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu b·∫£ng l∆∞∆°ng. M√£ l·ªói: ${response.status}`
            );
          }
          const salaryData = await response.json();

          if (!salaryData || Object.keys(salaryData).length === 0) {
            throw new Error(
              "Kh√¥ng c√≥ d·ªØ li·ªáu b·∫£ng l∆∞∆°ng cho th√°ng/nƒÉm ƒë√£ ch·ªçn."
            );
          }

          document.getElementById("selectedMonth").textContent = month;
          document.getElementById("selectedYear").textContent = year;
          document.getElementById("baseSalary").textContent =
            salaryData.base_salary;
          document.getElementById("bonus").textContent = salaryData.bonus;
          document.getElementById("present").textContent = salaryData.present;
          document.getElementById("absent").textContent = salaryData.absent;
          document.getElementById("leave").textContent = salaryData.leave;
          document.getElementById("deductions").textContent =
            salaryData.deductions;
          document.getElementById(
            "netSalary"
          ).innerHTML = `<b>${salaryData.net_salary}</b>`;

          salaryTable.style.display = "block";
        } catch (error) {
          console.error("L·ªói khi l·∫•y d·ªØ li·ªáu b·∫£ng l∆∞∆°ng:", error);
          errorMessage.textContent = error.message;
          errorMessage.style.display = "block";
        }
      }

      async function loadAttendanceData() {
        const attendanceTableBody = document.querySelector(
          "#attendanceTable tbody"
        );
        const attendanceError = document.getElementById("attendanceError");

        attendanceTableBody.innerHTML = "";
        attendanceError.style.display = "none";
        attendanceError.textContent = "";

        try {
          const response = await fetch("/api/attendance");
          if (!response.ok) {
            throw new Error(
              `Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu ng√†y c√¥ng. M√£ l·ªói: ${response.status}`
            );
          }
          const attendanceData = await response.json();

          if (attendanceData.length === 0) {
            throw new Error("Kh√¥ng c√≥ d·ªØ li·ªáu ng√†y c√¥ng.");
          }

          attendanceData.forEach((record) => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${record.date}</td>
              <td>${record.status}</td>
            `;
            attendanceTableBody.appendChild(row);
          });
        } catch (error) {
          console.error("L·ªói khi l·∫•y d·ªØ li·ªáu ng√†y c√¥ng:", error);
          attendanceError.textContent = error.message;
          attendanceError.style.display = "block";
        }
      }

      function getCurrentDate() {
        const today = new Date();
        return today.toISOString().split("T")[0];
      }

      function checkIn() {
        const now = new Date().toLocaleTimeString();
        localStorage.setItem("checkin_time", now);
        localStorage.setItem("checkin_date", getCurrentDate());
        updateStatus();
      }

      function checkOut() {
        const now = new Date().toLocaleTimeString();
        localStorage.setItem("checkout_time", now);
        updateStatus();
      }

      function updateStatus() {
        const checkinTime = localStorage.getItem("checkin_time");
        const checkoutTime = localStorage.getItem("checkout_time");
        const checkinDate = localStorage.getItem("checkin_date");
        const currentDate = getCurrentDate();

        if (checkinDate !== currentDate) {
          localStorage.removeItem("checkin_time");
          localStorage.removeItem("checkout_time");
          localStorage.setItem("checkin_date", currentDate);
          document.getElementById("status").textContent = "Ch∆∞a check-in";
        } else if (checkoutTime) {
          document.getElementById(
            "status"
          ).textContent = `ƒê√£ check-out l√∫c ${checkoutTime}`;
        } else if (checkinTime) {
          document.getElementById(
            "status"
          ).textContent = `ƒê√£ check-in l√∫c ${checkinTime}`;
        }
      }

      updateStatus();
    </script>
  </body>
</html>

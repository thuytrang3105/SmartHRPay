<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>B·∫£ng l∆∞∆°ng nh√¢n vi√™n - H·ªá th·ªëng Qu·∫£n l√Ω L∆∞∆°ng</title>
    <link rel="stylesheet" href="../static/payroll_AC.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
  </head>
  <body>
    <div class="container">
      <!-- Sidebar -->
      <div class="sidebar">
        <h2>Trang Ch·ªß Admin<br /></h2>
  
        <div class="menu-group">
          <h3>T·ªîNG QUAN</h3>
          <ul>
            <li>
              <a href="{{ url_for('dashboard_AD') }}"><i>üìä</i> Dashboard</a>
            </li>
          </ul>
        </div>
  
        <div class="menu-group">
          <h3>QU·∫¢N L√ù</h3>
          <ul>
            <li><a href="{{ url_for('employee_AD') }}"><i>üë•</i> Nh√¢n vi√™n</a></li>
            <li><a href="{{ url_for('payroll_AD') }}"><i>üí∞</i> L∆∞∆°ng</a></li>
            <li><a href="{{ url_for('shareholder') }}" ><i>üîë</i> C·ªï ƒê√¥ng</a></li>
            <li><a href="{{ url_for('user_roles') }}"><i>üè¢</i> Ph√¢n quy·ªÅn ng∆∞·ªùi d√πng</a></li>
            <li><a href="{{ url_for('notifications_AD') }}"><i>üì¢</i> Qu·∫£n l√Ω th√¥ng b√°o</a></li>
          </ul>
        </div>
  
        <div class="menu-group">
          <h3>B√ÅO C√ÅO</h3>
          <ul>
            <li>
              <a href="{{ url_for('reports_AD') }}"><i>üìà</i> B√°o c√°o nh√¢n s·ª±</a>
            </li>
            <li>
              <a href="{{ url_for('activity_log_AD') }}"><i>üìú</i> L·ªãch s·ª≠ ho·∫°t ƒë·ªông</a>
            </li>
          </ul>
        </div>
  
        <div class="menu-group">
          <h3>H·ªÜ TH·ªêNG</h3>
          <ul>
            <li>
              <li><a href="{{ url_for('logout') }}" ><i>üö™</i> ƒêƒÉng xu·∫•t</a></li>
            </li>
          </ul>
        </div>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <div class="header">
          <h2>H·ªá th·ªëng Qu·∫£n l√Ω L∆∞∆°ng</h2>
          <div class="user-info">
            <img
              src="https://ui-avatars.com/api/?name=Nguyen+Van+A&size=40&background=random"
              alt="User avatar"
            />
            <span>Nguy·ªÖn VƒÉn A | Qu·∫£n l√Ω L∆∞∆°ng</span>
          </div>
        </div>

        <!-- B·∫£ng l∆∞∆°ng nh√¢n vi√™n -->
        <div class="panel" id="payroll-editor">
          <div class="panel-header">
            <h3>B·∫£ng l∆∞∆°ng nh√¢n vi√™n</h3>
          </div>
          <div class="filter-box">
            <label for="month-filter">L·ªçc theo th√°ng: </label>
            <select id="month-filter" onchange="filterByMonth()">
              <!--<option value="">T·∫•t c·∫£</option> -->
              {% for month in available_months %}
              <option value="{{ month }}" {% if month == selected_month %}selected{% endif %}>
                {{ month }}
              </option>
              {% endfor %}
            </select>
          </div>
          <div class="panel-body">
            <table id="payroll-table">
              <thead>
                <tr>
                  <th>M√£ L∆∞∆°ng</th>
                  <th>M√£ NV</th>
                  <th>H·ªç v√† t√™n</th>
                  <th>Ph√≤ng ban</th>
                  <th>Ch·ª©c v·ª•</th>
                  <th>L∆∞∆°ng c∆° b·∫£n</th>
                  <th>Th∆∞·ªüng</th>
                  <th>Kh·∫•u tr·ª´</th>
                  <th>T·ªïng l∆∞∆°ng</th>
                  <th>Th√°ng</th>
                  <th>Thao t√°c</th>
                </tr>
              </thead>
              <tbody>
                {% for payroll, employee in payroll_data %}
                <tr>
                  <td>{{ payroll.payroll_id }}</td>
                  <td>{{ employee.id_display }}</td>
                  <td>{{ employee.employee_name }}</td>
                  <td>{{ employee.department_name }}</td>
                  <td>{{ employee.job_title }}</td>
                  <td>{{ "{:,.0f}".format(employee.base_salary) }} ƒë</td>
                  <td>{{ "{:,.0f}".format(employee.bonus) }} ƒë</td>
                  <td>{{ "{:,.0f}".format(employee.deduction) }} ƒë</td>
                  <td>{{ "{:,.0f}".format(employee.total_salary) }} ƒë</td>
                  <td>{{ payroll.pay_date.strftime('%Y-%m') }}</td>
                  <td class="table-actions">
                    <button class="btn btn-sm btn-warning edit-payroll" data-id="{{ employee.employee_id }}">
                      S·ª≠a
                    </button>
                  </td>
                </tr>
                {% endfor %}
                {% if payroll_data|length == 0 %}
                <tr>
                  <td colspan="11" class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu nh√¢n vi√™n n√†o ph√π h·ª£p.</td>
                </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script>
      function filterByMonth() {
        const selectedMonth = document.getElementById('month-filter').value;
        const url = selectedMonth ? `/payroll_AD?month=${selectedMonth}` : '/payroll_AD';
        window.location.href = url;
      }
    </script>
<!-- Modal for Editing Employee -->
<div id="employee-modal" class="modal-backdrop" style="display: none">
  <div class="modal">
    <div class="modal-header">
      <h3>Ch·ªânh s·ª≠a nh√¢n vi√™n</h3>
      <button id="close-modal" style="background: none; border: none; cursor: pointer">
        <i class="fa fa-times"></i>
      </button>
    </div>
    <form id="edit-employee-form">
      <div class="modal-body">
        <input type="hidden" id="edit-employee-id" name="payroll_id" />
        <div class="grid-cols-2 mb-4">
          <div>
            <label>M√£ nh√¢n vi√™n</label>
            <input type="text" id="edit-employee-code" name="payroll_id" readonly />
          </div>
          <div>
            <label>H·ªç v√† t√™n</label>
            <input type="text" id="edit-employee-name" name="employee_name" required />
          </div>
        </div>
        <div class="grid-cols-2 mb-4">
          <div>
            <label>Ph√≤ng ban</label>
            <select id="edit-employee-department" name="department_name" required>
              {% for dept in departments %}
              <option value="{{ dept }}">{{ dept }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label>Ch·ª©c v·ª•</label>
            <select id="edit-employee-job" name="job_title" required>
              {% for job in jobs %}
              <option value="{{ job }}">{{ job }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="grid-cols-3 mb-4">
          <div>
            <label>L∆∞∆°ng c∆° b·∫£n</label>
            <input type="number" id="edit-employee-base-salary" name="base_salary" required />
          </div>
          <div>
            <label>Th∆∞·ªüng</label>
            <input type="number" id="edit-employee-bonus" name="bonus" required />
          </div>
          <div>
            <label>Kh·∫•u tr·ª´</label>
            <input type="number" id="edit-employee-deduction" name="deduction" required />
          </div>
        </div>
        <div class="mb-4">
          <label>Ghi ch√∫</label>
          <textarea rows="3" id="edit-employee-notes" name="notes" placeholder="Nh·∫≠p ghi ch√∫ (n·∫øu c√≥)"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button id="cancel-modal" type="button" class="btn" style="background-color: #f5f5f5; color: #333; border: 1px solid #ddd;">
          H·ªßy b·ªè
        </button>
        <button type="submit" class="btn">L∆∞u</button>
      </div>
    </form>
  </div>
</div>

<script>
  function handleResponsive() {
    const sidebar = document.querySelector(".sidebar");
    const mainContent = document.querySelector(".main-content");
    if (window.innerWidth <= 768) {
      sidebar.style.width = "70px";
      mainContent.style.marginLeft = "70px";
    } else {
      sidebar.style.width = "250px";
      mainContent.style.marginLeft = "250px";
    }
  }
  handleResponsive();
  window.addEventListener("resize", handleResponsive);

  const modal = document.getElementById("employee-modal");
  const editButtons = document.querySelectorAll(".edit-payroll");
  const closeModalBtn = document.getElementById("close-modal");
  const cancelModalBtn = document.getElementById("cancel-modal");
  const editForm = document.getElementById("edit-employee-form");

  function toggleModal() {
    modal.style.display = modal.style.display === "none" ? "flex" : "none";
  }

  editButtons.forEach((button) => {
    button.addEventListener("click", function () {
      const employeeId = this.getAttribute("data-id");
      fetch(`/get_employee/${employeeId}`)
        .then((response) => response.json())
        .then((employee) => {
          if (employee.error) {
            alert(employee.error);
            return;
          }
          document.getElementById("edit-employee-id").value = employee.employee_id;
          document.getElementById("edit-employee-code").value = employee.id_display;
          document.getElementById("edit-employee-name").value = employee.employee_name;
          document.getElementById("edit-employee-department").value = employee.department_name;
          document.getElementById("edit-employee-job").value = employee.job_title;
          document.getElementById("edit-employee-base-salary").value = employee.base_salary;
          document.getElementById("edit-employee-bonus").value = employee.bonus;
          document.getElementById("edit-employee-deduction").value = employee.deduction;
          document.getElementById("edit-employee-notes").value = employee.note || "";
          toggleModal();
        })
        .catch((error) => {
          console.error("Error:", error);
          alert("Kh√¥ng th·ªÉ t·∫£i th√¥ng tin nh√¢n vi√™n");
        });
    });
  });

  closeModalBtn.addEventListener("click", toggleModal);
  cancelModalBtn.addEventListener("click", toggleModal);
  modal.addEventListener("click", function (e) {
    if (e.target === this) toggleModal();
  });

  editForm.addEventListener("submit", function (e) {
    e.preventDefault();
    const employeeId = document.getElementById("edit-employee-id").value;
    const formData = new FormData(this);
    fetch(`/update_employee/${employeeId}`, {
      method: "POST",
      body: formData,
    })
      .then((response) => response.json())
      .then((result) => {
        if (result.message === "C·∫≠p nh·∫≠t nh√¢n vi√™n th√†nh c√¥ng") {
          alert("C·∫≠p nh·∫≠t th√†nh c√¥ng");
          location.reload();
        } else {
          alert("C·∫≠p nh·∫≠t th·∫•t b·∫°i: " + (result.error || "L·ªói kh√¥ng x√°c ƒë·ªãnh"));
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        alert("C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t");
      });
  });

  function filterByMonth() {
    const selectedMonth = document.getElementById('month-filter').value;
    const url = selectedMonth ? `/payroll_AD?month=${selectedMonth}` : '/payroll_AD';
    window.location.href = url;
  }
</script>
</body>
</html>
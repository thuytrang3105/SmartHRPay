<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bảng lương nhân viên - Hệ thống Quản lý Lương</title>
    <link rel="stylesheet" href="../static/common_AC.css" />
    <link rel="stylesheet" href="../static/payroll_AC.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
  </head>
  <body>
    <div class="container">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="sidebar-header">
          <h3>Payroll Manager</h3>
          <p>Hệ thống Quản lý Lương</p>
        </div>
        <div class="sidebar-menu">
          <a href="{{ url_for('home_AC') }}" class="menu-item">
            <i class="fa fa-money-bill"></i>
            <span>Home </span>
          </a>
          <a href="{{ url_for('payroll') }}" class="menu-item">
            <i class="fa fa-money-bill"></i>
            <span>Bảng lương nhân viên</span>
          </a>
          <a href="{{ url_for('department_report') }}" class="menu-item">
            <i class="fa fa-building"></i>
            <span>Báo cáo theo phòng ban</span>
          </a>
          <a href="{{ url_for('history_payroll') }}" class="menu-item">
            <i class="fa fa-history"></i>
            <span>Lịch sử lương nhân viên</span>
          </a>
          <a href="{{ url_for('get_notifications') }}" class="menu-item">
            <i class="fa fa-bell"></i>
            <span>Thông báo bảng lương</span>
          </a>
          <a href="{{ url_for('logout') }}" class="menu-item">
            <i class="fa fa-sign-out-alt"></i>
            <span>Đăng xuất</span>
          </a>
        </div>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <div class="header">
          <h2>Hệ thống Quản lý Lương</h2>
          <div class="user-info">
            <img
              src="https://ui-avatars.com/api/?name=Nguyen+Van+A&size=40&background=random"
              alt="User avatar"
            />
            <span>Nguyễn Văn A | Quản lý Lương</span>
          </div>
        </div>

        <!-- UC14: Bảng lương nhân viên -->
        <div class="panel" id="payroll-editor">
          <div class="panel-header">
            <h3>Bảng lương nhân viên</h3>
            <button class="btn" id="show-modal">Thêm nhân viên</button>
          </div>
          <div class="panel-body">
            <div class="filter-container">
              <div class="search-box">
                <i class="fa fa-search"></i>
                <input type="text" placeholder="Tìm kiếm nhân viên..." />
              </div>

              <label>Phòng ban</label>
              <select id="department-filter">
                <option value="">Chọn phòng ban</option>
                {% for dept in departments %}
                <option value="{{ dept|lower }}" {% if selected_department == dept|lower %}selected{% endif %}>{{ dept }}</option>
                {% endfor %}
              </select>

              <label>Chức vụ</label>
              <select id="position-filter">
                <option value="">Chọn chức vụ</option>
                {% for pos in positions %}
                <option value="{{ pos|lower }}" {% if selected_position == pos|lower %}selected{% endif %}>{{ pos }}</option>
                {% endfor %}
              </select>

              <!-- Nút Bỏ lọc: Chỉ hiển thị khi có bộ lọc được áp dụng -->
              {% if selected_department or selected_position %}
              <button id="clear-filter" class="btn" style="background-color: #f5f5f5; color: #333; border: 1px solid #ddd; margin-left: 10px;">
                Bỏ lọc
              </button>
              {% endif %}

              <table>
                <thead>
                  <tr>
                    <th>Mã NV</th>
                    <th>Họ và tên</th>
                    <th>Phòng ban</th>
                    <th>Lương cơ bản</th>
                    <th>Thưởng</th>
                    <th>Khấu trừ</th>
                    <th>Tổng lương</th>
                    <th>Thao tác</th>
                  </tr>
                </thead>
                <tbody>
                  {% for employee in payroll_data %}
                  <tr>
                    <td>{{ employee.id_dp }}</td>
                    <td>{{ employee.name }}</td>
                    <td>{{ employee.department }}</td>
                    <td>{{ "{:,.0f}".format(employee.base_salary) }} đ</td>
                    <td>{{ "{:,.0f}".format(employee.bonus) }} đ</td>
                    <td>{{ "{:,.0f}".format(employee.deduction) }} đ</td>
                    <td>{{ "{:,.0f}".format(employee.total_salary) }} đ</td>
                    <td class="table-actions">
                      <button class="btn btn-sm btn-warning edit-payroll" data-id="{{ employee.id }}">Sửa</button>
                      <a href="{{ url_for('payroll_detail', employee_id=employee.id) }}" class="btn btn-sm btn-success" >Chi tiết </a>
                    </td>
                  </tr>
                  {% endfor %}
                  {% if payroll_data|length == 0 %}
                  <tr>
                    <td colspan="8" class="text-center">Không có dữ liệu nhân viên nào phù hợp.</td>
                  </tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal -->
    <div id="employee-modal" class="modal-backdrop" style="display: none">
      <div class="modal">
        <div class="modal-header">
          <h3 id="modal-title">Thêm nhân viên mới</h3>
          <button id="close-modal" style="background: none; border: none; cursor: pointer">
            <i class="fa fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <form id="employee-form">
            <input type="hidden" id="employee-id" name="employee_id">
            <div class="grid-cols-2 mb-4">
              <div>
                <label>Mã nhân viên</label>
                <input type="text" id="employee-id-dp" name="id_dp" readonly />
              </div>
              <div>
                <label>Họ và tên</label>
                <input type="text" id="employee-name" name="name" placeholder="Nhập họ và tên" />
              </div>
            </div>

            <div class="grid-cols-2 mb-4">
              <div>
                <label>Phòng ban</label>
                <select id="employee-department" name="department">
                  <option value="">Chọn phòng ban</option>
                  {% for dept in departments %}
                  <option value="{{ dept }}">{{ dept }}</option>
                  {% endfor %}
                </select>
              </div>
              <div>
                <label>Chức vụ</label>
                <select id="employee-position" name="position">
                  <option value="">Chọn chức vụ</option>
                  {% for pos in positions %}
                  <option value="{{ pos }}">{{ pos }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>

            <div class="grid-cols-3 mb-4">
              <div>
                <label>Lương cơ bản</label>
                <input type="number" id="base-salary" name="base_salary" placeholder="Nhập lương cơ bản" />
              </div>
              <div>
                <label>Thưởng</label>
                <input type="number" id="bonus" name="bonus" placeholder="Nhập thưởng" />
              </div>
              <div>
                <label>Khấu trừ</label>
                <input type="number" id="deduction" name="deduction" placeholder="Nhập khấu trừ" />
              </div>
            </div>

            <div class="mb-4">
              <label>Ghi chú</label>
              <textarea id="note" name="note" rows="3" placeholder="Nhập ghi chú (nếu có)"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button id="cancel-modal" class="btn" style="background-color: #f5f5f5; color: #333; border: 1px solid #ddd;">
            Hủy bỏ
          </button>
          <button id="save-employee" class="btn">Lưu</button>
        </div>
      </div>
    </div>

    <script>
      // Handle responsive sidebar
      function handleResponsive() {
        const sidebar = document.querySelector(".sidebar");
        const mainContent = document.querySelector(".main-content");

        if (window.innerWidth <= 768) {
          sidebar.style.width = "70px";
          mainContent.style.marginLeft = "70px";
        } else {
          sidebar.style.width = "250px";
          mainContent.style.marginLeft = "250px";
        }
      }

      handleResponsive();
      window.addEventListener("resize", handleResponsive);

      // Modal handling
      const modal = document.getElementById("employee-modal");
      const showModalBtn = document.getElementById("show-modal");
      const closeModalBtn = document.getElementById("close-modal");
      const cancelModalBtn = document.getElementById("cancel-modal");
      const saveBtn = document.getElementById("save-employee");
      const modalTitle = document.getElementById("modal-title");

      function toggleModal() {
        modal.style.display = modal.style.display === "none" ? "flex" : "none";
      }

      showModalBtn.addEventListener("click", () => {
        modalTitle.textContent = "Thêm nhân viên mới";
        document.getElementById("employee-form").reset();
        document.getElementById("employee-id").value = "";
        toggleModal();
      });

      closeModalBtn.addEventListener("click", toggleModal);
      cancelModalBtn.addEventListener("click", toggleModal);

      modal.addEventListener("click", function (e) {
        if (e.target === this) {
          toggleModal();
        }
      });

      // Handle edit buttons
      const editButtons = document.querySelectorAll(".edit-payroll");
      editButtons.forEach((button) => {
        button.addEventListener("click", function () {
          const employeeId = this.getAttribute("data-id");
          fetch(`/get_employee/${employeeId}`)
            .then(response => response.json())
            .then(data => {
              if (data.error) {
                alert(data.error);
                return;
              }

              // Điền thông tin cũ vào form
              modalTitle.textContent = "Chỉnh sửa nhân viên";
              document.getElementById("employee-id").value = data.employee_id;
              document.getElementById("employee-id-dp").value = data.id_dp;
              document.getElementById("employee-name").value = data.name;
              document.getElementById("employee-department").value = data.department;
              document.getElementById("employee-position").value = data.position;
              document.getElementById("base-salary").value = data.base_salary;
              document.getElementById("bonus").value = data.bonus;
              document.getElementById("deduction").value = data.deduction;
              document.getElementById("note").value = data.note || "";
              toggleModal();
            })
            .catch(error => {
              console.error("Lỗi:", error);
              alert("Đã có lỗi xảy ra khi lấy thông tin nhân viên.");
            });
        });
      });

      // Handle save button
      saveBtn.addEventListener("click", function () {
        const employeeId = document.getElementById("employee-id").value;
        const formData = new FormData(document.getElementById("employee-form"));

        if (employeeId) {
          // Cập nhật nhân viên
          fetch(`/update_employee/${employeeId}`, {
            method: "POST",
            body: formData
          })
            .then(response => response.json())
            .then(data => {
              if (data.error) {
                alert(data.error);
                return;
              }
              alert(data.message);
              toggleModal();
              window.location.reload(); // Tải lại trang để cập nhật bảng
            })
            .catch(error => {
              console.error("Lỗi:", error);
              alert("Đã có lỗi xảy ra khi cập nhật nhân viên.");
            });
        } else {
          // Thêm nhân viên mới (logic này cần được triển khai nếu bạn muốn hỗ trợ thêm nhân viên)
          alert("Chức năng thêm nhân viên chưa được triển khai.");
        }
      });

      // Handle filter dropdowns
      document.addEventListener("DOMContentLoaded", function() {
        const departmentSelect = document.getElementById("department-filter");
        const positionSelect = document.getElementById("position-filter");
        const clearFilterBtn = document.getElementById("clear-filter");

        function applyFilters() {
          const selectedDepartment = departmentSelect.value;
          const selectedPosition = positionSelect.value;

          let url = "/payroll_AC";
          let params = [];
          if (selectedDepartment) params.push(`department=${selectedDepartment}`);
          if (selectedPosition) params.push(`position=${selectedPosition}`);
          if (params.length) url += "?" + params.join("&");

          window.location.href = url;
        }

        departmentSelect.addEventListener("change", applyFilters);
        positionSelect.addEventListener("change", applyFilters);

        if (clearFilterBtn) {
          clearFilterBtn.addEventListener("click", function() {
            window.location.href = "/payroll_AC";
          });
        }
      });
    </script>
  </body>
</html>
<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qu·∫£n L√Ω C√¥ng Vi·ªác v√† Ph√≤ng Ban</title>
    <link rel="stylesheet" href="../static/depart_pos.css" />
  </head>
  <body>
    <!-- Sidebar -->
    <div class="sidebar">
      <h2>Trang Ch·ªß HR<br /></h2>
      <div class="menu-group">
        <h3>QU·∫¢N L√ù</h3>
        <ul>
          <li>
            <a href="{{ url_for('employee_HR') }}"><i>üë•</i> Nh√¢n vi√™n</a>
          </li>
          <li>
            <a href="{{ url_for('depart_pos') }}" class="active">
              <i>üëî</i> Ph√≤ng ban v√† c√¥ng vi·ªác
            </a>
          </li>
          <li>
            <a href="{{ url_for('reports_HR') }}"><i>üìà</i> B√°o c√°o nh√¢n s·ª± </a>
          </li>
        </ul>
      </div>
      <div class="menu-group">
        <h3>H·ªÜ TH·ªêNG</h3>
        <ul>
          <li>
            <a href="{{ url_for('logout') }}"><i>üö™</i> ƒêƒÉng xu·∫•t</a>
          </li>
        </ul>
      </div>
    </div>


    <!-- Main Content -->
    <div class="main-content">
      <div class="header">
        <h1>Qu·∫£n L√Ω C√¥ng Vi·ªác v√† Ph√≤ng Ban</h1>
        <div class="user-info">NGUY·ªÑN VƒÇN A <br />HR</div>
      </div>
      <!-- Thanh ƒëi·ªÅu h∆∞·ªõng tab -->
      <div class="tab-container">
        <button class="tab-button active" onclick="showSection('jobs')">
          C√¥ng Vi·ªác
        </button>
        <button class="tab-button" onclick="showSection('departments')">
          Ph√≤ng Ban
        </button>
      </div>
      <!-- Ph·∫ßn C√¥ng Vi·ªác -->
      <div id="jobs" class="section-tab" style="display: block">
        <div class="section">
          <div class="section-title">C√¥ng Vi·ªác</div>
          <div class="table-container">
            <div class="table-header">
              <div class="search-container">
                <input
                  type="text"
                  class="search-bar"
                  id="searchJobInput"
                  placeholder="T√¨m ki·∫øm c√¥ng vi·ªác..."
                />
                <button class="search-btn" onclick="searchJobs()">
                  T√¨m ki·∫øm
                </button>
              </div>
              <button class="add-btn" onclick="openAddJobModal()">
                Th√™m C√¥ng Vi·ªác
              </button>
            </div>
            <table id="jobTable">
              <thead>
                <tr>
                  <th>M√£ C√¥ng Vi·ªác</th>
                  <th>T√™n C√¥ng Vi·ªác</th>
                  <th>H√†nh ƒê·ªông</th>
                </tr>
              </thead>
              <tbody id="jobBody">
                {% for job in jobs %}
                <tr>
                  <td>{{ job.job_id }}</td>
                  <td>{{ job.job_title }}</td>
                  <td>
                    <button
                      class="action-btn view-btn"
                      onclick="viewJobEmployees('{{ job.job_id }}', '{{ job.job_title }}')"
                    >
                      Xem
                    </button>
                    <button
                      class="action-btn delete-btn"
                      onclick="deleteJob('{{ job.job_id }}')"
                    >
                      X√≥a
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Ph·∫ßn Ph√≤ng Ban -->
      <div id="departments" class="section-tab" style="display: none">
        <div class="section">
          <div class="section-title">Ph√≤ng Ban</div>
          <div class="table-container">
            <div class="table-header">
              <div class="search-container">
                <input
                  type="text"
                  class="search-bar"
                  id="searchDepartmentInput"
                  placeholder="T√¨m ki·∫øm ph√≤ng ban..."
                />
                <button class="search-btn" onclick="searchDepartments()">
                  T√¨m ki·∫øm
                </button>
              </div>
              <button class="add-btn" onclick="openAddDepartmentModal()">
                Th√™m Ph√≤ng Ban
              </button>
            </div>
            <table id="departmentTable">
              <thead>
                <tr>
                  <th>M√£ Ph√≤ng Ban</th>
                  <th>T√™n Ph√≤ng Ban</th>
                  <th>H√†nh ƒê·ªông</th>
                </tr>
              </thead>
              <tbody id="departmentBody">
                {% for department in departments %}
                <tr>
                  <td>{{ department.department_id }}</td>
                  <td>{{ department.department_name }}</td>
                  <td>
                    <button
                      class="action-btn view-btn"
                      onclick="viewDepartmentEmployees('{{ department.department_id }}', '{{ department.department_name }}')"
                    >
                      Xem
                    </button>
                    <button
                      class="action-btn delete-btn"
                      onclick="deleteDepartment('{{ department.department_id }}')"
                    >
                      X√≥a
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Th√™m C√¥ng Vi·ªác -->
    <div id="addJobModal" class="modal">
      <div class="modal-content">
        <h2>Th√™m C√¥ng Vi·ªác</h2>
        <form id="addJobForm">
          <label for="jobTitle">T√™n C√¥ng Vi·ªác:</label>
          <input type="text" id="jobTitle" name="job_title" required />
          <div class="modal-buttons">
            <button
              type="button"
              class="cancel-btn"
              onclick="closeAddJobModal()"
            >
              H·ªßy
            </button>
            <button type="submit" class="save-btn">L∆∞u</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Th√™m Ph√≤ng Ban -->
    <div id="addDepartmentModal" class="modal">
      <div class="modal-content">
        <h2>Th√™m Ph√≤ng Ban</h2>
        <form id="addDepartmentForm">
          <label for="departmentName">T√™n Ph√≤ng Ban:</label>
          <input
            type="text"
            id="departmentName"
            name="department_name"
            required
          />
          <div class="modal-buttons">
            <button
              type="button"
              class="cancel-btn"
              onclick="closeAddDepartmentModal()"
            >
              H·ªßy
            </button>
            <button type="submit" class="save-btn">L∆∞u</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Xem Danh S√°ch Nh√¢n Vi√™n Theo C√¥ng Vi·ªác -->
    <div id="jobEmployeesModal" class="modal">
      <div class="modal-content">
        <h2>
          Danh S√°ch Nh√¢n Vi√™n Theo C√¥ng Vi·ªác:
          <span id="jobTitleDisplay"></span>
        </h2>
        <table id="jobEmployeesTable">
          <thead>
            <tr>
              <th>M√£ Nh√¢n Vi√™n</th>
              <th>T√™n</th>
              <th>Email</th>
            </tr>
          </thead>
          <tbody id="jobEmployeesBody"></tbody>
        </table>
        <div class="modal-buttons">
          <button class="close-btn" onclick="closeJobEmployeesModal()">
            ƒê√≥ng
          </button>
        </div>
      </div>
    </div>

    <!-- Modal Xem Danh S√°ch Nh√¢n Vi√™n Theo Ph√≤ng Ban -->
    <div id="departmentEmployeesModal" class="modal">
      <div class="modal-content">
        <h2>
          Danh S√°ch Nh√¢n Vi√™n Theo Ph√≤ng Ban:
          <span id="departmentNameDisplay"></span>
        </h2>
        <table id="departmentEmployeesTable">
          <thead>
            <tr>
              <th>M√£ Nh√¢n Vi√™n</th>
              <th>T√™n</th>
              <th>Email</th>
            </tr>
          </thead>
          <tbody id="departmentEmployeesBody"></tbody>
        </table>
        <div class="modal-buttons">
          <button class="close-btn" onclick="closeDepartmentEmployeesModal()">
            ƒê√≥ng
          </button>
        </div>
      </div>
    </div>

    <script>
      function showSection(sectionId) {
        document.getElementById("jobs").style.display = "none";
        document.getElementById("departments").style.display = "none";
        document.getElementById(sectionId).style.display = "block";
        document.querySelectorAll(".tab-button").forEach((button) => {
          button.classList.remove("active");
        });
        document
          .querySelector(`.tab-button[onclick="showSection('${sectionId}')"]`)
          .classList.add("active");
      }
      // --- C√¥ng vi·ªác ---
      function openAddJobModal() {
        document.getElementById("addJobModal").style.display = "block";
      }

      function closeAddJobModal() {
        document.getElementById("addJobModal").style.display = "none";
        document.getElementById("addJobForm").reset();
      }

      document
        .getElementById("addJobForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const jobTitle = document.getElementById("jobTitle").value;
          fetch("/api/add_job", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: `job_title=${jobTitle}`,
          })
            .then((response) => response.json())
            .then((data) => {
              const tableBody = document.getElementById("jobBody");
              const newRow = document.createElement("tr");
              newRow.innerHTML = `
                    <td>${data.job_id}</td>
                    <td>${data.job_tile}</td>
                    <td>
                        <button class="action-btn view-btn" onclick="viewJobEmployees('${data.job_id}', '${data.job_title}')">Xem</button>
                        <button class="action-btn delete-btn" onclick="deleteJob('${data.job_id}')">X√≥a</button>
                    </td>
                `;
              tableBody.appendChild(newRow);
              closeAddJobModal();
            })
            .catch((error) => {
              console.error("L·ªói khi th√™m c√¥ng vi·ªác:", error);
              alert("ƒê√£ x·∫£y ra l·ªói khi th√™m c√¥ng vi·ªác.");
            });
        });

      function searchJobs() {
        const input = document
          .querySelector("#searchJobInput")
          .value.toLowerCase();
        const rows = document.querySelectorAll("#jobBody tr");
        rows.forEach((row) => {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(input) ? "" : "none";
        });
      }

      function viewJobEmployees(jobId, jobTitle) {
        document.getElementById("jobEmployeesModal").style.display = "block";
        document.getElementById("jobTitleDisplay").textContent = jobTitle;
        fetch(`/api/employees_by_jobjob/${jobId}`)
          .then((response) => response.json())
          .then((data) => {
            const tableBody = document.getElementById("jobEmployeesBody");
            tableBody.innerHTML = "";
            if (data.length === 0) {
              tableBody.innerHTML = `<tr><td colspan="3">Kh√¥ng c√≥ nh√¢n vi√™n n√†o thu·ªôc c√¥ng vi·ªác n√†y.</td></tr>`;
            } else {
              data.forEach((emp) => {
                const row = document.createElement("tr");
                row.innerHTML = `<td>${emp.employee_id}</td><td>${emp.full_name}</td><td>${emp.email}</td>`;
                tableBody.appendChild(row);
              });
            }
          })
          .catch((error) => {
            console.error("L·ªói khi l·∫•y d·ªØ li·ªáu t·ª´ API:", error);
            const tableBody = document.getElementById("jobEmployeesBody");
            tableBody.innerHTML = `<tr><td colspan="3">ƒê√£ x·∫£y ra l·ªói khi t·∫£i d·ªØ li·ªáu.</td></tr>`;
          });
      }

      function closeJobEmployeesModal() {
        document.getElementById("jobEmployeesModal").style.display = "none";
      }

      function deleteJob(jobId) {
        if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a c√¥ng vi·ªác ${jobId}?`)) {
          fetch(`/api/delete_jobjob/${jobId}`, { method: "DELETE" })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                const row = document.querySelector(
                  `#jobBody tr td:first-child:contains('${jobId}')`
                ).parentElement;
                row.remove();
              }
            })
            .catch((error) => {
              console.error("L·ªói khi x√≥a c√¥ng vi·ªác:", error);
              alert("ƒê√£ x·∫£y ra l·ªói khi x√≥a c√¥ng vi·ªác.");
            });
        }
      }

      // --- Ph√≤ng Ban ---
      function openAddDepartmentModal() {
        document.getElementById("addDepartmentModal").style.display = "block";
      }

      function closeAddDepartmentModal() {
        document.getElementById("addDepartmentModal").style.display = "none";
        document.getElementById("addDepartmentForm").reset();
      }

      document
        .getElementById("addDepartmentForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const departmentName =
            document.getElementById("departmentName").value;
          fetch("/api/add_department", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: `department_name=${departmentName}`,
          })
            .then((response) => response.json())
            .then((data) => {
              const tableBody = document.getElementById("departmentBody");
              const newRow = document.createElement("tr");
              newRow.innerHTML = `
                    <td>${data.department_id}</td>
                    <td>${data.department_name}</td>
                    <td>
                        <button class="action-btn view-btn" onclick="viewDepartmentEmployees('${data.department_id}', '${data.department_name}')">Xem</button>
                        <button class="action-btn delete-btn" onclick="deleteDepartment('${data.department_id}')">X√≥a</button>
                    </td>
                `;
              tableBody.appendChild(newRow);
              closeAddDepartmentModal();
            })
            .catch((error) => {
              console.error("L·ªói khi th√™m ph√≤ng ban:", error);
              alert("ƒê√£ x·∫£y ra l·ªói khi th√™m ph√≤ng ban.");
            });
        });

      function searchDepartments() {
        const input = document
          .querySelector("#searchDepartmentInput")
          .value.toLowerCase();
        const rows = document.querySelectorAll("#departmentBody tr");
        rows.forEach((row) => {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(input) ? "" : "none";
        });
      }

      function viewDepartmentEmployees(departmentId, departmentName) {
        document.getElementById("departmentEmployeesModal").style.display =
          "block";
        document.getElementById("departmentNameDisplay").textContent =
          departmentName;
        fetch(`/api/employees_by_department/${departmentId}`)
          .then((response) => response.json())
          .then((data) => {
            const tableBody = document.getElementById(
              "departmentEmployeesBody"
            );
            tableBody.innerHTML = "";
            if (data.length === 0) {
              tableBody.innerHTML = `<tr><td colspan="3">Kh√¥ng c√≥ nh√¢n vi√™n n√†o thu·ªôc ph√≤ng ban n√†y.</td></tr>`;
            } else {
              data.forEach((emp) => {
                const row = document.createElement("tr");
                row.innerHTML = `<td>${emp.employee_id}</td><td>${emp.full_name}</td><td>${emp.email}</td>`;
                tableBody.appendChild(row);
              });
            }
          })
          .catch((error) => {
            console.error("L·ªói khi l·∫•y d·ªØ li·ªáu t·ª´ API:", error);
            const tableBody = document.getElementById(
              "departmentEmployeesBody"
            );
            tableBody.innerHTML = `<tr><td colspan="3">ƒê√£ x·∫£y ra l·ªói khi t·∫£i d·ªØ li·ªáu.</td></tr>`;
          });
      }

      function closeDepartmentEmployeesModal() {
        document.getElementById("departmentEmployeesModal").style.display =
          "none";
      }

      function deleteDepartment(departmentId) {
        if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ph√≤ng ban ${departmentId}?`)) {
          fetch(`/api/delete_department/${departmentId}`, { method: "DELETE" })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                const row = document.querySelector(
                  `#departmentBody tr td:first-child:contains('${departmentId}')`
                ).parentElement;
                row.remove();
              }
            })
            .catch((error) => {
              console.error("L·ªói khi x√≥a ph√≤ng ban:", error);
              alert("ƒê√£ x·∫£y ra l·ªói khi x√≥a ph√≤ng ban.");
            });
        }
      }

      // H√†m h·ªó tr·ª£ t√¨m ki·∫øm
      HTMLElement.prototype.contains = function (text) {
        return this.textContent.includes(text);
      };
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quáº£n LÃ½ Tuyá»ƒn Dá»¥ng</title>
    <link rel="stylesheet" href="../static/employee_HR.css" />
  </head>
  <body>
    <!-- Sidebar -->
    <div class="sidebar">
      <h2>Trang Chá»§ HR<br /></h2>
      <div class="menu-group">
        <h3>QUáº¢N LÃ</h3>
        <ul>
          <li>
            <a href="{{ url_for('employee_HR') }}"><i>ğŸ‘¥</i> NhÃ¢n viÃªn</a>
          </li>
          <li>
            <a href="{{ url_for('depart_pos') }}">
              <i>ğŸ‘”</i> PhÃ²ng ban vÃ  cÃ´ng viá»‡c
            </a>
          </li>
          <li>
            <a href="{{ url_for('recruitment_HR') }}" class="active">
              <i>ğŸ“</i> Quáº£n LÃ­ Tuyá»ƒn Dá»¥ng
            </a>
          </li>
          
          <li>
            <a href="{{ url_for('reports_HR') }}"><i>ğŸ“ˆ</i> BÃ¡o cÃ¡o nhÃ¢n sá»± </a>
          </li>
        </ul>
      </div>
      <div class="menu-group">
        <h3>Há»† THá»NG</h3>
        <ul>
          <li>
            <a href="{{ url_for('logout_hr') }}"><i>ğŸšª</i> ÄÄƒng xuáº¥t</a>
          </li>
        </ul>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <div class="header">
        <h1>Quáº£n LÃ½ Tuyá»ƒn Dá»¥ng</h1>
        <!-- <div class="user-info">NGUYá»„N VÄ‚N A <br />HR</div> -->
      </div>

      <div class="employee-table">
        <div class="table-header">
          <div class="search-container">
            <input
              type="text"
              class="search-bar"
              id="searchInput"
              placeholder="TÃ¬m kiáº¿m vá»‹ trÃ­ tuyá»ƒn dá»¥ng..."
            />
            <button class="search-btn" onclick="searchRecruitments()">
              TÃ¬m kiáº¿m
            </button>
          </div>
          <button class="add-btn" onclick="openAddModal()">
            ThÃªm Vá»‹ TrÃ­ Tuyá»ƒn Dá»¥ng
          </button>
        </div>
        <table id="recruitmentTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Vá»‹ TrÃ­</th>
              <th>PhÃ²ng Ban</th>
              <th>NgÃ y ÄÄƒng</th>
              <th>Tráº¡ng ThÃ¡i</th>
              <th>Sá»‘ á»¨ng ViÃªn</th>
              <th>HÃ nh Äá»™ng</th>
            </tr>
          </thead>
          <tbody id="recruitmentBody">
            <!-- Dá»¯ liá»‡u sáº½ Ä‘Æ°á»£c thÃªm báº±ng JavaScript -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Modal ThÃªm Vá»‹ TrÃ­ Tuyá»ƒn Dá»¥ng -->
    <div id="addRecruitmentModal" class="modal">
      <div class="modal-content">
        <h2>ThÃªm Vá»‹ TrÃ­ Tuyá»ƒn Dá»¥ng</h2>
        <form id="addRecruitmentForm">
          <label for="title">Chá»©c danh:</label>
          <input type="text" id="title" name="title" required />

          <label for="department">PhÃ²ng ban:</label>
          <input type="text" id="department" name="department" required />

          <label for="posted_date">NgÃ y Ä‘Äƒng:</label>
          <input type="date" id="posted_date" name="posted_date" required />

          <label for="status">Tráº¡ng thÃ¡i:</label>
          <select id="status" name="status" required>
            <option value="Äang tuyá»ƒn">Äang tuyá»ƒn</option>
            <option value="Táº¡m dá»«ng">Táº¡m dá»«ng</option>
            <option value="ÄÃ£ Ä‘Ã³ng">ÄÃ£ Ä‘Ã³ng</option>
          </select>

          <label for="description">MÃ´ táº£ cÃ´ng viá»‡c:</label>
          <textarea id="description" name="description" rows="4" required></textarea>

          <label for="requirements">YÃªu cáº§u (má»—i yÃªu cáº§u má»™t dÃ²ng):</label>
          <textarea id="requirements" name="requirements" rows="6" required></textarea>

          <div class="modal-buttons">
            <button type="button" class="cancel-btn" onclick="closeAddModal()">
              Há»§y
            </button>
            <button type="submit" class="save-btn">LÆ°u</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Xem vÃ  Chá»‰nh Sá»­a Vá»‹ TrÃ­ Tuyá»ƒn Dá»¥ng -->
    <div id="viewRecruitmentModal" class="modal">
      <div class="modal-content">
        <h2>ThÃ´ng Tin Vá»‹ TrÃ­ Tuyá»ƒn Dá»¥ng</h2>
        <table id="recruitmentDetailsTable">
          <tr>
            <th>ID:</th>
            <td><input type="text" id="editRecruitmentId" disabled /></td>
          </tr>
          <tr>
            <th>Chá»©c danh:</th>
            <td><input type="text" id="editTitle" /></td>
          </tr>
          <tr>
            <th>PhÃ²ng ban:</th>
            <td><input type="text" id="editDepartment" /></td>
          </tr>
          <tr>
            <th>NgÃ y Ä‘Äƒng:</th>
            <td><input type="date" id="editPostedDate" /></td>
          </tr>
          <tr>
            <th>Tráº¡ng thÃ¡i:</th>
            <td>
              <select id="editStatus">
                <option value="Äang tuyá»ƒn">Äang tuyá»ƒn</option>
                <option value="Táº¡m dá»«ng">Táº¡m dá»«ng</option>
                <option value="ÄÃ£ Ä‘Ã³ng">ÄÃ£ Ä‘Ã³ng</option>
              </select>
            </td>
          </tr>
          <tr>
            <th>MÃ´ táº£ cÃ´ng viá»‡c:</th>
            <td><textarea id="editDescription" rows="4"></textarea></td>
          </tr>
          <tr>
            <th>YÃªu cáº§u:</th>
            <td><textarea id="editRequirements" rows="6"></textarea></td>
          </tr>
        </table>
        <div class="modal-buttons">
          <button id="editButton" class="action-btn edit-btn" onclick="enableEditMode()">
            Chá»‰nh sá»­a
          </button>
          <button class="action-btn close-btn" onclick="closeViewModal()">
            ThoÃ¡t
          </button>
        </div>
      </div>
    </div>

    <!-- Modal Xem Danh SÃ¡ch á»¨ng ViÃªn -->
    <div id="viewApplicantsModal" class="modal">
      <div class="modal-content">
        <h2>Danh SÃ¡ch á»¨ng ViÃªn</h2>
        <div id="recruitmentTitle" class="recruitment-title"></div>
        <table id="applicantsTable">
          <thead>
            <tr>
              <th>Há» TÃªn</th>
              <th>Email</th>
              <th>HÃ nh Äá»™ng</th>
            </tr>
          </thead>
          <tbody id="applicantsBody">
            <!-- Dá»¯ liá»‡u sáº½ Ä‘Æ°á»£c thÃªm báº±ng JavaScript -->
          </tbody>
        </table>
        <div class="modal-buttons">
          <button class="action-btn close-btn" onclick="closeApplicantsModal()">
            ÄÃ³ng
          </button>
        </div>
      </div>
    </div>

    <script>
      // Sá»­ dá»¥ng Ä‘Æ°á»ng dáº«n tÆ°Æ¡ng Ä‘á»‘i vÃ¬ HTML vÃ  API cÃ¹ng nguá»“n gá»‘c
      const API_URL = "/api/recruitments";

      // Táº£i danh sÃ¡ch vá»‹ trÃ­ tuyá»ƒn dá»¥ng tá»« API khi trang Ä‘Æ°á»£c táº£i
      window.onload = function () {
        loadRecruitments();
      };

      async function loadRecruitments() {
        try {
          const response = await fetch(API_URL);
          if (!response.ok) {
            throw new Error(
              `KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u tá»« API. MÃ£ lá»—i: ${response.status}`
            );
          }
          const recruitments = await response.json();
          console.log("Dá»¯ liá»‡u tá»« API:", recruitments);
          const tableBody = document.getElementById("recruitmentBody");
          tableBody.innerHTML = ""; // XÃ³a dá»¯ liá»‡u cÅ©

          recruitments.forEach((recruitment) => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${recruitment.id}</td>
              <td>${recruitment.title}</td>
              <td>${recruitment.department}</td>
              <td>${recruitment.posted_date}</td>
              <td>${recruitment.status}</td>
              <td>${recruitment.applicants ? recruitment.applicants.length : 0}</td>
              <td>
                <button class="action-btn view-btn" onclick="viewRecruitment(${recruitment.id})">Xem</button>
                <button class="action-btn view-btn" onclick="viewApplicants(${recruitment.id})">á»¨ng viÃªn</button>
                <button class="action-btn delete-btn" onclick="deleteRecruitment(${recruitment.id})">XÃ³a</button>
              </td>
            `;
            tableBody.appendChild(row);
          });
        } catch (error) {
          console.error("Lá»—i khi táº£i danh sÃ¡ch tuyá»ƒn dá»¥ng:", error);
          alert(
            "KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u tuyá»ƒn dá»¥ng. Vui lÃ²ng kiá»ƒm tra API hoáº·c káº¿t ná»‘i."
          );
        }
      }

      // Xem thÃ´ng tin vá»‹ trÃ­ tuyá»ƒn dá»¥ng
      async function viewRecruitment(recruitmentId) {
        try {
          const response = await fetch(`${API_URL}/${recruitmentId}`);
          if (!response.ok) {
            throw new Error(
              `KhÃ´ng thá»ƒ láº¥y thÃ´ng tin tuyá»ƒn dá»¥ng. MÃ£ lá»—i: ${response.status}`
            );
          }
          const recruitment = await response.json();
          if (recruitment) {
            document.getElementById("editRecruitmentId").value = recruitment.id;
            document.getElementById("editTitle").value = recruitment.title;
            document.getElementById("editDepartment").value = recruitment.department;
            document.getElementById("editPostedDate").value = formatDateForInput(recruitment.posted_date);
            document.getElementById("editStatus").value = recruitment.status;
            document.getElementById("editDescription").value = recruitment.description;
            document.getElementById("editRequirements").value = recruitment.requirements.join("\n");

            // VÃ´ hiá»‡u hÃ³a cÃ¡c trÆ°á»ng trong cháº¿ Ä‘á»™ xem
            const inputs = document.querySelectorAll(
              "#recruitmentDetailsTable input, #recruitmentDetailsTable select, #recruitmentDetailsTable textarea"
            );
            inputs.forEach((input) => {
              if (input.id !== "editRecruitmentId") input.disabled = true;
            });

            document.querySelector(".modal-buttons").innerHTML = `
              <button id="editButton" class="action-btn edit-btn" onclick="enableEditMode()">Chá»‰nh sá»­a</button>
              <button class="action-btn close-btn" onclick="closeViewModal()">ThoÃ¡t</button>
            `;

            document.getElementById("viewRecruitmentModal").style.display = "flex";
          }
        } catch (error) {
          console.error("Lá»—i khi xem thÃ´ng tin tuyá»ƒn dá»¥ng:", error);
          alert(
            "KhÃ´ng thá»ƒ xem thÃ´ng tin tuyá»ƒn dá»¥ng. Vui lÃ²ng kiá»ƒm tra API hoáº·c káº¿t ná»‘i."
          );
        }
      }

      // Xem danh sÃ¡ch á»©ng viÃªn
      async function viewApplicants(recruitmentId) {
        try {
          const response = await fetch(`${API_URL}/${recruitmentId}`);
          if (!response.ok) {
            throw new Error(`KhÃ´ng thá»ƒ láº¥y thÃ´ng tin á»©ng viÃªn. MÃ£ lá»—i: ${response.status}`);
          }
          const recruitment = await response.json();
          
          // Hiá»ƒn thá»‹ tÃªn vá»‹ trÃ­ tuyá»ƒn dá»¥ng
          document.getElementById("recruitmentTitle").textContent = 
            `Vá»‹ trÃ­: ${recruitment.title} - ${recruitment.department}`;
          
          const tableBody = document.getElementById("applicantsBody");
          tableBody.innerHTML = ""; // XÃ³a dá»¯ liá»‡u cÅ©
          
          if (recruitment.applicants && recruitment.applicants.length > 0) {
            recruitment.applicants.forEach((applicant) => {
              const row = document.createElement("tr");
              row.innerHTML = `
                <td>${applicant.name}</td>
                <td>${applicant.email}</td>
                <td>
                  <button class="action-btn view-btn" onclick="alert('Chá»©c nÄƒng Ä‘ang phÃ¡t triá»ƒn')">Xem há»“ sÆ¡</button>
                </td>
              `;
              tableBody.appendChild(row);
            });
          } else {
            // Náº¿u khÃ´ng cÃ³ á»©ng viÃªn
            const row = document.createElement("tr");
            row.innerHTML = `
              <td colspan="3" style="text-align: center;">ChÆ°a cÃ³ á»©ng viÃªn nÃ o cho vá»‹ trÃ­ nÃ y</td>
            `;
            tableBody.appendChild(row);
          }

          document.getElementById("viewApplicantsModal").style.display = "flex";
        } catch (error) {
          console.error("Lá»—i khi xem danh sÃ¡ch á»©ng viÃªn:", error);
          alert("KhÃ´ng thá»ƒ xem danh sÃ¡ch á»©ng viÃªn. Vui lÃ²ng kiá»ƒm tra API hoáº·c káº¿t ná»‘i.");
        }
      }

      // KÃ­ch hoáº¡t cháº¿ Ä‘á»™ chá»‰nh sá»­a
      function enableEditMode() {
        const inputs = document.querySelectorAll(
          "#recruitmentDetailsTable input, #recruitmentDetailsTable select, #recruitmentDetailsTable textarea"
        );
        inputs.forEach((input) => {
          if (input.id !== "editRecruitmentId") input.disabled = false;
        });

        document.querySelector(".modal-buttons").innerHTML = `
          <button class="action-btn save-btn" onclick="saveRecruitment()">LÆ°u</button>
          <button class="action-btn cancel-btn" onclick="cancelEdit()">Há»§y</button>
        `;
      }

      // LÆ°u thay Ä‘á»•i vá»‹ trÃ­ tuyá»ƒn dá»¥ng
      async function saveRecruitment() {
        const recruitmentId = document.getElementById("editRecruitmentId").value;
        const updatedRecruitment = {
          title: document.getElementById("editTitle").value,
          department: document.getElementById("editDepartment").value,
          posted_date: document.getElementById("editPostedDate").value,
          status: document.getElementById("editStatus").value,
          description: document.getElementById("editDescription").value,
          requirements: document.getElementById("editRequirements").value.split("\n").filter(line => line.trim() !== "")
        };

        try {
          const response = await fetch(`${API_URL}/${recruitmentId}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(updatedRecruitment),
          });
          if (response.ok) {
            loadRecruitments();
            closeViewModal();
            alert("Cáº­p nháº­t thÃ nh cÃ´ng!");
          } else {
            console.error("Lá»—i khi cáº­p nháº­t vá»‹ trÃ­ tuyá»ƒn dá»¥ng");
            alert("KhÃ´ng thá»ƒ cáº­p nháº­t vá»‹ trÃ­ tuyá»ƒn dá»¥ng. Vui lÃ²ng thá»­ láº¡i.");
          }
        } catch (error) {
          console.error("Lá»—i khi cáº­p nháº­t vá»‹ trÃ­ tuyá»ƒn dá»¥ng:", error);
          alert(
            "KhÃ´ng thá»ƒ cáº­p nháº­t vá»‹ trÃ­ tuyá»ƒn dá»¥ng. Vui lÃ²ng kiá»ƒm tra API hoáº·c káº¿t ná»‘i."
          );
        }
      }

      // Há»§y chá»‰nh sá»­a
      function cancelEdit() {
        const recruitmentId = document.getElementById("editRecruitmentId").value;
        viewRecruitment(recruitmentId); // Quay láº¡i cháº¿ Ä‘á»™ xem
      }

      // ÄÃ³ng modal xem
      function closeViewModal() {
        document.getElementById("viewRecruitmentModal").style.display = "none";
      }

      // ÄÃ³ng modal xem á»©ng viÃªn
      function closeApplicantsModal() {
        document.getElementById("viewApplicantsModal").style.display = "none";
      }

      // Má»Ÿ modal thÃªm vá»‹ trÃ­ tuyá»ƒn dá»¥ng
      function openAddModal() {
        // Tá»± Ä‘á»™ng Ä‘iá»n ngÃ y hÃ´m nay
        const today = new Date();
        const formattedDate = formatDateForInput(today.toISOString().split('T')[0]);
        document.getElementById("posted_date").value = formattedDate;
        
        document.getElementById("addRecruitmentModal").style.display = "flex";
      }

      // ÄÃ³ng modal thÃªm vá»‹ trÃ­ tuyá»ƒn dá»¥ng
      function closeAddModal() {
        document.getElementById("addRecruitmentModal").style.display = "none";
        document.getElementById("addRecruitmentForm").reset();
      }

      // ThÃªm vá»‹ trÃ­ tuyá»ƒn dá»¥ng má»›i
      document
        .getElementById("addRecruitmentForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          const newRecruitment = {
            title: document.getElementById("title").value,
            department: document.getElementById("department").value,
            posted_date: document.getElementById("posted_date").value,
            status: document.getElementById("status").value,
            description: document.getElementById("description").value,
            requirements: document.getElementById("requirements").value.split("\n").filter(line => line.trim() !== ""),
            applicants: []
          };

          try {
            const response = await fetch(API_URL, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(newRecruitment),
            });
            if (response.ok) {
              loadRecruitments();
              closeAddModal();
              alert("ThÃªm vá»‹ trÃ­ tuyá»ƒn dá»¥ng thÃ nh cÃ´ng!");
            } else {
              console.error("Lá»—i khi thÃªm vá»‹ trÃ­ tuyá»ƒn dá»¥ng");
              alert("KhÃ´ng thá»ƒ thÃªm vá»‹ trÃ­ tuyá»ƒn dá»¥ng. Vui lÃ²ng thá»­ láº¡i.");
            }
          } catch (error) {
            console.error("Lá»—i khi thÃªm vá»‹ trÃ­ tuyá»ƒn dá»¥ng:", error);
            alert(
              "KhÃ´ng thá»ƒ thÃªm vá»‹ trÃ­ tuyá»ƒn dá»¥ng. Vui lÃ²ng kiá»ƒm tra API hoáº·c káº¿t ná»‘i."
            );
          }
        });

      // XÃ³a vá»‹ trÃ­ tuyá»ƒn dá»¥ng
      async function deleteRecruitment(recruitmentId) {
        try {
          // Äáº§u tiÃªn láº¥y thÃ´ng tin vá»‹ trÃ­ Ä‘á»ƒ hiá»ƒn thá»‹ tÃªn trong thÃ´ng bÃ¡o xÃ¡c nháº­n
          const infoResponse = await fetch(`${API_URL}/${recruitmentId}`);
          if (!infoResponse.ok) {
            throw new Error(`KhÃ´ng thá»ƒ láº¥y thÃ´ng tin tuyá»ƒn dá»¥ng. MÃ£ lá»—i: ${infoResponse.status}`);
          }
          const recruitment = await infoResponse.json();
          
          if (confirm(`Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a vá»‹ trÃ­ "${recruitment.title}" khÃ´ng?`)) {
            const response = await fetch(`${API_URL}/${recruitmentId}`, {
              method: "DELETE",
            });
            if (response.ok) {
              loadRecruitments();
              alert("XÃ³a vá»‹ trÃ­ tuyá»ƒn dá»¥ng thÃ nh cÃ´ng!");
            } else {
              console.error("Lá»—i khi xÃ³a vá»‹ trÃ­ tuyá»ƒn dá»¥ng");
              alert("KhÃ´ng thá»ƒ xÃ³a vá»‹ trÃ­ tuyá»ƒn dá»¥ng. Vui lÃ²ng thá»­ láº¡i.");
            }
          }
        } catch (error) {
          console.error("Lá»—i khi xÃ³a vá»‹ trÃ­ tuyá»ƒn dá»¥ng:", error);
          alert(
            "KhÃ´ng thá»ƒ xÃ³a vá»‹ trÃ­ tuyá»ƒn dá»¥ng. Vui lÃ²ng kiá»ƒm tra API hoáº·c káº¿t ná»‘i."
          );
        }
      }

      // TÃ¬m kiáº¿m vá»‹ trÃ­ tuyá»ƒn dá»¥ng
      function searchRecruitments() {
        const input = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const rows = document.querySelectorAll("#recruitmentBody tr");
        rows.forEach((row) => {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(input) ? "" : "none";
        });
      }

      // HÃ m há»— trá»£ Ä‘á»‹nh dáº¡ng ngÃ y thÃ¡ng tá»« "yyyy/mm/dd" hoáº·c "yyyy-mm-dd" sang Ä‘á»‹nh dáº¡ng cho input type="date"
      function formatDateForInput(dateString) {
        if (!dateString) return '';
        // Xá»­ lÃ½ cáº£ Ä‘á»‹nh dáº¡ng yyyy/mm/dd vÃ  yyyy-mm-dd
        const parts = dateString.includes('/') ? dateString.split('/') : dateString.split('-');
        if (parts.length !== 3) return dateString;
        
        // Äáº£m báº£o Ä‘á»‹nh dáº¡ng yyyy-mm-dd cho input type="date"
        return `${parts[0]}-${parts[1].padStart(2, '0')}-${parts[2].padStart(2, '0')}`;
      }
    </script>
  </body>
</html>
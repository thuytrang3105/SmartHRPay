<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qu·∫£n L√Ω C√¥ng Vi·ªác v√† Ph√≤ng Ban</title>
    <link rel="stylesheet" href="../static/depart_pos.css" />
  </head>
  <body>
    <!-- Sidebar -->
    <div class="sidebar">
      <h2>Trang Ch·ªß HR<br /></h2>
      <div class="menu-group">
        <h3>QU·∫¢N L√ù</h3>
        <ul>
          <li>
            <a href="{{ url_for('employee_HR') }}"><i>üë•</i> Nh√¢n vi√™n</a>
          </li>
          <li>
            <a href="{{ url_for('depart_pos') }}" class="active">
              <i>üëî</i> Ph√≤ng ban v√† c√¥ng vi·ªác
            </a>
          </li>
          <li>
            <a href="{{ url_for('recruitment_HR') }}"><i>üìù</i> Qu·∫£n L√≠ Tuy·ªÉn D·ª•ng </a>
          </li>
          <li>
            <a href="{{ url_for('reports_HR') }}"><i>üìà</i> B√°o c√°o nh√¢n s·ª± </a>
          </li>
        </ul>
      </div>
      <div class="menu-group">
        <h3>H·ªÜ TH·ªêNG</h3>
        <ul>
          <li>
            <a href="{{ url_for('logout_hr') }}"><i>üö™</i> ƒêƒÉng xu·∫•t</a>
          </li>
        </ul>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <div class="header">
        <h1>Qu·∫£n L√Ω C√¥ng Vi·ªác v√† Ph√≤ng Ban</h1>
        <div class="user-info">NGUY·ªÑN VƒÇN A <br />HR</div>
      </div>
      <!-- Thanh ƒëi·ªÅu h∆∞·ªõng tab -->
      <div class="tab-container">
        <button class="tab-button active" onclick="showSection('jobs')">
          C√¥ng Vi·ªác
        </button>
        <button class="tab-button" onclick="showSection('departments')">
          Ph√≤ng Ban
        </button>
      </div>
      <!-- Ph·∫ßn C√¥ng Vi·ªác -->
      <div id="jobs" class="section-tab" style="display: block">
        <div class="section">
          <div class="section-title">C√¥ng Vi·ªác</div>
          <div class="table-container">
            <div class="table-header">
              <div class="search-container">
                <input
                  type="text"
                  class="search-bar"
                  id="searchJobInput"
                  placeholder="T√¨m ki·∫øm c√¥ng vi·ªác..."
                />
                <button class="search-btn" onclick="searchJobs()">
                  T√¨m ki·∫øm
                </button>
              </div>
              <button class="add-btn" onclick="openAddJobModal()">
                Th√™m C√¥ng Vi·ªác
              </button>
            </div>
            <table id="jobTable">
              <thead>
                <tr>
                  <th>M√£ C√¥ng Vi·ªác</th>
                  <th>T√™n C√¥ng Vi·ªác</th>
                  <th>H√†nh ƒê·ªông</th>
                </tr>
              </thead>
              <tbody id="jobBody">
                {% for job in jobs %}
                <tr data-job-id="{{ job.job_id }}">
                  <td>{{ job.job_id }}</td>
                  <td>{{ job.job_title }}</td>
                  <td>
                    <button
                      class="action-btn view-btn"
                      onclick="viewJobEmployees('{{ job.job_id }}', '{{ job.job_title }}')"
                    >
                      Xem
                    </button>
                    <button 
                      class="action-btn edit-btn" 
                      onclick="openEditJobModal('{{ job.job_id }}', '{{ job.job_title }}')"
                    >
                      S·ª≠a
                    </button>
                    <button
                      class="action-btn delete-btn"
                      onclick="deleteJob('{{ job.job_id }}')"
                    >
                      X√≥a
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Ph·∫ßn Ph√≤ng Ban -->
      <div id="departments" class="section-tab" style="display: none">
        <div class="section">
          <div class="section-title">Ph√≤ng Ban</div>
          <div class="table-container">
            <div class="table-header">
              <div class="search-container">
                <input
                  type="text"
                  class="search-bar"
                  id="searchDepartmentInput"
                  placeholder="T√¨m ki·∫øm ph√≤ng ban..."
                />
                <button class="search-btn" onclick="searchDepartments()">
                  T√¨m ki·∫øm
                </button>
              </div>
              <button class="add-btn" onclick="openAddDepartmentModal()">
                Th√™m Ph√≤ng Ban
              </button>
            </div>
            <table id="departmentTable">
              <thead>
                <tr>
                  <th>M√£ Ph√≤ng Ban</th>
                  <th>T√™n Ph√≤ng Ban</th>
                  <th>H√†nh ƒê·ªông</th>
                </tr>
              </thead>
              <tbody id="departmentBody">
                {% for department in departments %}
                <tr data-department-id="{{ department.department_id }}">
                  <td>{{ department.department_id }}</td>
                  <td>{{ department.department_name }}</td>
                  <td>
                    <button
                      class="action-btn view-btn"
                      onclick="viewDepartmentEmployees('{{ department.department_id }}', '{{ department.department_name }}')"
                    >
                      Xem
                    </button>
                    <button 
                      class="action-btn edit-btn" 
                      onclick="openEditDepartmentModal('{{ department.department_id }}', '{{ department.department_name }}')"
                    >
                      S·ª≠a
                    </button>
                    <button
                      class="action-btn delete-btn"
                      onclick="deleteDepartment('{{ department.department_id }}')"
                    >
                      X√≥a
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Th√™m C√¥ng Vi·ªác -->
    <div id="addJobModal" class="modal">
      <div class="modal-content">
        <h2>Th√™m C√¥ng Vi·ªác</h2>
        <form id="addJobForm">
          <label for="jobTitle">T√™n C√¥ng Vi·ªác:</label>
          <input type="text" id="jobTitle" name="job_title" required />
          <div class="modal-buttons">
            <button
              type="button"
              class="cancel-btn"
              onclick="closeAddJobModal()"
            >
              H·ªßy
            </button>
            <button type="submit" class="save-btn">L∆∞u</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal S·ª≠a C√¥ng Vi·ªác -->
    <div id="editJobModal" class="modal">
      <div class="modal-content">
        <h2>S·ª≠a C√¥ng Vi·ªác</h2>
        <form id="editJobForm">
          <input type="hidden" id="editJobId" name="job_id" />
          <label for="editJobTitle">T√™n C√¥ng Vi·ªác:</label>
          <input type="text" id="editJobTitle" name="job_title" required />
          <div class="modal-buttons">
            <button
              type="button"
              class="cancel-btn"
              onclick="closeEditJobModal()"
            >
              H·ªßy
            </button>
            <button type="submit" class="save-btn">L∆∞u</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Th√™m Ph√≤ng Ban -->
    <div id="addDepartmentModal" class="modal">
      <div class="modal-content">
        <h2>Th√™m Ph√≤ng Ban</h2>
        <form id="addDepartmentForm">
          <label for="departmentName">T√™n Ph√≤ng Ban:</label>
          <input
            type="text"
            id="departmentName"
            name="department_name"
            required
          />
          <div class="modal-buttons">
            <button
              type="button"
              class="cancel-btn"
              onclick="closeAddDepartmentModal()"
            >
              H·ªßy
            </button>
            <button type="submit" class="save-btn">L∆∞u</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal S·ª≠a Ph√≤ng Ban -->
    <div id="editDepartmentModal" class="modal">
      <div class="modal-content">
        <h2>S·ª≠a Ph√≤ng Ban</h2>
        <form id="editDepartmentForm">
          <input type="hidden" id="editDepartmentId" name="department_id" />
          <label for="editDepartmentName">T√™n Ph√≤ng Ban:</label>
          <input
            type="text"
            id="editDepartmentName"
            name="department_name"
            required
          />
          <div class="modal-buttons">
            <button
              type="button"
              class="cancel-btn"
              onclick="closeEditDepartmentModal()"
            >
              H·ªßy
            </button>
            <button type="submit" class="save-btn">L∆∞u</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Xem Danh S√°ch Nh√¢n Vi√™n Theo C√¥ng Vi·ªác -->
    <div id="jobEmployeesModal" class="modal">
      <div class="modal-content">
        <h2>
          Danh S√°ch Nh√¢n Vi√™n Theo C√¥ng Vi·ªác:
          <span id="jobTitleDisplay"></span>
        </h2>
        <table id="jobEmployeesTable">
          <thead>
            <tr>
              <th>M√£ Nh√¢n Vi√™n</th>
              <th>T√™n</th>
              <th>Email</th>
            </tr>
          </thead>
          <tbody id="jobEmployeesBody"></tbody>
        </table>
        <div class="modal-buttons">
          <button class="close-btn" onclick="closeJobEmployeesModal()">
            ƒê√≥ng
          </button>
        </div>
      </div>
    </div>

    <!-- Modal Xem Danh S√°ch Nh√¢n Vi√™n Theo Ph√≤ng Ban -->
    <div id="departmentEmployeesModal" class="modal">
      <div class="modal-content">
        <h2>
          Danh S√°ch Nh√¢n Vi√™n Theo Ph√≤ng Ban:
          <span id="departmentNameDisplay"></span>
        </h2>
        <table id="departmentEmployeesTable">
          <thead>
            <tr>
              <th>M√£ Nh√¢n Vi√™n</th>
              <th>T√™n</th>
              <th>Email</th>
            </tr>
          </thead>
          <tbody id="departmentEmployeesBody"></tbody>
        </table>
        <div class="modal-buttons">
          <button class="close-btn" onclick="closeDepartmentEmployeesModal()">
            ƒê√≥ng
          </button>
        </div>
      </div>
    </div>
  </body>
</html>
<script>
  // --- Hi·ªÉn th·ªã tab ---
function showSection(sectionId) {
    document.getElementById("jobs").style.display = "none";
    document.getElementById("departments").style.display = "none";
    document.getElementById(sectionId).style.display = "block";
    document.querySelectorAll(".tab-button").forEach((button) => {
        button.classList.remove("active");
    });
    document.querySelector(`.tab-button[onclick="showSection('${sectionId}')"]`).classList.add("active");
}

// --- Qu·∫£n l√Ω c√¥ng vi·ªác ---
function openAddJobModal() {
    document.getElementById("addJobModal").style.display = "block";
}

function closeAddJobModal() {
    document.getElementById("addJobModal").style.display = "none";
    document.getElementById("addJobForm").reset();
}

// Th√™m c√¥ng vi·ªác m·ªõi
function addJob() {
    const jobTitle = document.getElementById("jobTitle").value;
    
    fetch("/api/add_job", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ job_title: jobTitle })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error("L·ªói khi th√™m c√¥ng vi·ªác");
        }
        return response.json();
    })
    .then(data => {
        const tableBody = document.getElementById("jobBody");
        const newRow = document.createElement("tr");
        newRow.dataset.jobId = data.job_id;
        newRow.innerHTML = `
            <td>${data.job_id}</td>
            <td>${data.job_title}</td>
            <td>
                <button class="action-btn view-btn" onclick="viewJobEmployees('${data.job_id}', '${data.job_title}')">Xem</button>
                <button class="action-btn edit-btn" onclick="openEditJobModal('${data.job_id}', '${data.job_title}')">S·ª≠a</button>
                <button class="action-btn delete-btn" onclick="deleteJob('${data.job_id}')">X√≥a</button>
            </td>
        `;
        tableBody.appendChild(newRow);
        closeAddJobModal();
    })
    .catch(error => {
        console.error("L·ªói:", error);
        alert("ƒê√£ x·∫£y ra l·ªói khi th√™m c√¥ng vi·ªác.");
    });
}

// X√≥a c√¥ng vi·ªác
function deleteJob(jobId) {
    if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a c√¥ng vi·ªác c√≥ ID ${jobId}?`)) {
        fetch(`/api/delete_job/${jobId}`, { 
            method: "DELETE" 
        })
        .then(response => {
            if (!response.ok) {
                throw new Error("L·ªói khi x√≥a c√¥ng vi·ªác");
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                const row = document.querySelector(`tr[data-job-id="${jobId}"]`);
                if (row) {
                    row.remove();
                }
            }
        })
        .catch(error => {
            console.error("L·ªói:", error);
            alert("ƒê√£ x·∫£y ra l·ªói khi x√≥a c√¥ng vi·ªác.");
        });
    }
}

// Modal ch·ªânh s·ª≠a c√¥ng vi·ªác
function openEditJobModal(jobId, jobTitle) {
    document.getElementById("editJobId").value = jobId;
    document.getElementById("editJobTitle").value = jobTitle;
    document.getElementById("editJobModal").style.display = "block";
}

function closeEditJobModal() {
    document.getElementById("editJobModal").style.display = "none";
    document.getElementById("editJobForm").reset();
}

// C·∫≠p nh·∫≠t c√¥ng vi·ªác
function updateJob() {
    const jobId = document.getElementById("editJobId").value;
    const jobTitle = document.getElementById("editJobTitle").value;
    
    fetch(`/api/update_job/${jobId}`, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ job_title: jobTitle })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error("L·ªói khi c·∫≠p nh·∫≠t c√¥ng vi·ªác");
        }
        return response.json();
    })
    .then(data => {
        const row = document.querySelector(`tr[data-job-id="${jobId}"]`);
        if (row) {
            row.querySelector("td:nth-child(2)").textContent = jobTitle;
            // C·∫≠p nh·∫≠t n√∫t "Xem" v·ªõi title m·ªõi
            const viewButton = row.querySelector(".view-btn");
            viewButton.setAttribute("onclick", `viewJobEmployees('${jobId}', '${jobTitle}')`);
        }
        closeEditJobModal();
    })
    .catch(error => {
        console.error("L·ªói:", error);
        alert("ƒê√£ x·∫£y ra l·ªói khi c·∫≠p nh·∫≠t c√¥ng vi·ªác.");
    });
}

// T√¨m ki·∫øm c√¥ng vi·ªác
function searchJobs() {
    const input = document.getElementById("searchJobInput").value.toLowerCase();
    const rows = document.querySelectorAll("#jobBody tr");
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(input) ? "" : "none";
    });
}

// Xem nh√¢n vi√™n theo c√¥ng vi·ªác
function viewJobEmployees(jobId, jobTitle) {
    document.getElementById("jobEmployeesModal").style.display = "block";
    document.getElementById("jobTitleDisplay").textContent = jobTitle;
    
    fetch(`/api/employees_by_job/${jobId}`)
    .then(response => {
        if (!response.ok) {
            throw new Error("L·ªói khi l·∫•y d·ªØ li·ªáu nh√¢n vi√™n");
        }
        return response.json();
    })
    .then(data => {
        const tableBody = document.getElementById("jobEmployeesBody");
        tableBody.innerHTML = "";
        if (data.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="3">Kh√¥ng c√≥ nh√¢n vi√™n n√†o thu·ªôc c√¥ng vi·ªác n√†y.</td></tr>`;
        } else {
            data.forEach(emp => {
                const row = document.createElement("tr");
                row.innerHTML = `<td>${emp.employee_id}</td><td>${emp.full_name}</td><td>${emp.email}</td>`;
                tableBody.appendChild(row);
            });
        }
    })
    .catch(error => {
        console.error("L·ªói:", error);
        const tableBody = document.getElementById("jobEmployeesBody");
        tableBody.innerHTML = `<tr><td colspan="3">ƒê√£ x·∫£y ra l·ªói khi t·∫£i d·ªØ li·ªáu.</td></tr>`;
    });
}

function closeJobEmployeesModal() {
    document.getElementById("jobEmployeesModal").style.display = "none";
}

// --- Qu·∫£n l√Ω ph√≤ng ban ---
function openAddDepartmentModal() {
    document.getElementById("addDepartmentModal").style.display = "block";
}

function closeAddDepartmentModal() {
    document.getElementById("addDepartmentModal").style.display = "none";
    document.getElementById("addDepartmentForm").reset();
}

// Th√™m ph√≤ng ban m·ªõi
function addDepartment() {
    const departmentName = document.getElementById("departmentName").value;
    
    fetch("/api/add_department", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ department_name: departmentName })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error("L·ªói khi th√™m ph√≤ng ban");
        }
        return response.json();
    })
    .then(data => {
        const tableBody = document.getElementById("departmentBody");
        const newRow = document.createElement("tr");
        newRow.dataset.departmentId = data.department_id;
        newRow.innerHTML = `
            <td>${data.department_id}</td>
            <td>${data.department_name}</td>
            <td>
                <button class="action-btn view-btn" onclick="viewDepartmentEmployees('${data.department_id}', '${data.department_name}')">Xem</button>
                <button class="action-btn edit-btn" onclick="openEditDepartmentModal('${data.department_id}', '${data.department_name}')">S·ª≠a</button>
                <button class="action-btn delete-btn" onclick="deleteDepartment('${data.department_id}')">X√≥a</button>
            </td>
        `;
        tableBody.appendChild(newRow);
        closeAddDepartmentModal();
    })
    .catch(error => {
        console.error("L·ªói:", error);
        alert("ƒê√£ x·∫£y ra l·ªói khi th√™m ph√≤ng ban.");
    });
}

// X√≥a ph√≤ng ban
function deleteDepartment(departmentId) {
    if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ph√≤ng ban c√≥ ID ${departmentId}?`)) {
        fetch(`/api/delete_department/${departmentId}`, { 
            method: "DELETE" 
        })
        .then(response => {
            if (!response.ok) {
                throw new Error("L·ªói khi x√≥a ph√≤ng ban");
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                const row = document.querySelector(`tr[data-department-id="${departmentId}"]`);
                if (row) {
                    row.remove();
                }
            }
        })
        .catch(error => {
            console.error("L·ªói:", error);
            alert("ƒê√£ x·∫£y ra l·ªói khi x√≥a ph√≤ng ban.");
        });
    }
}

// Modal ch·ªânh s·ª≠a ph√≤ng ban
function openEditDepartmentModal(departmentId, departmentName) {
    document.getElementById("editDepartmentId").value = departmentId;
    document.getElementById("editDepartmentName").value = departmentName;
    document.getElementById("editDepartmentModal").style.display = "block";
}

function closeEditDepartmentModal() {
    document.getElementById("editDepartmentModal").style.display = "none";
    document.getElementById("editDepartmentForm").reset();
}

// C·∫≠p nh·∫≠t ph√≤ng ban
function updateDepartment() {
    const departmentId = document.getElementById("editDepartmentId").value;
    const departmentName = document.getElementById("editDepartmentName").value;
    
    fetch(`/api/update_department/${departmentId}`, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ department_name: departmentName })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error("L·ªói khi c·∫≠p nh·∫≠t ph√≤ng ban");
        }
        return response.json();
    })
    .then(data => {
        const row = document.querySelector(`tr[data-department-id="${departmentId}"]`);
        if (row) {
            row.querySelector("td:nth-child(2)").textContent = departmentName;
            // C·∫≠p nh·∫≠t n√∫t "Xem" v·ªõi t√™n m·ªõi
            const viewButton = row.querySelector(".view-btn");
            viewButton.setAttribute("onclick", `viewDepartmentEmployees('${departmentId}', '${departmentName}')`);
        }
        closeEditDepartmentModal();
    })
    .catch(error => {
        console.error("L·ªói:", error);
        alert("ƒê√£ x·∫£y ra l·ªói khi c·∫≠p nh·∫≠t ph√≤ng ban.");
    });
}

// T√¨m ki·∫øm ph√≤ng ban
function searchDepartments() {
    const input = document.getElementById("searchDepartmentInput").value.toLowerCase();
    const rows = document.querySelectorAll("#departmentBody tr");
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(input) ? "" : "none";
    });
}

// Xem nh√¢n vi√™n theo ph√≤ng ban
function viewDepartmentEmployees(departmentId, departmentName) {
    document.getElementById("departmentEmployeesModal").style.display = "block";
    document.getElementById("departmentNameDisplay").textContent = departmentName;
    
    fetch(`/api/employees_by_department/${departmentId}`)
    .then(response => {
        if (!response.ok) {
            throw new Error("L·ªói khi l·∫•y d·ªØ li·ªáu nh√¢n vi√™n");
        }
        return response.json();
    })
    .then(data => {
        const tableBody = document.getElementById("departmentEmployeesBody");
        tableBody.innerHTML = "";
        if (data.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="3">Kh√¥ng c√≥ nh√¢n vi√™n n√†o thu·ªôc ph√≤ng ban n√†y.</td></tr>`;
        } else {
            data.forEach(emp => {
                const row = document.createElement("tr");
                row.innerHTML = `<td>${emp.employee_id}</td><td>${emp.full_name}</td><td>${emp.email}</td>`;
                tableBody.appendChild(row);
            });
        }
    })
    .catch(error => {
        console.error("L·ªói:", error);
        const tableBody = document.getElementById("departmentEmployeesBody");
        tableBody.innerHTML = `<tr><td colspan="3">ƒê√£ x·∫£y ra l·ªói khi t·∫£i d·ªØ li·ªáu.</td></tr>`;
    });
}

function closeDepartmentEmployeesModal() {
    document.getElementById("departmentEmployeesModal").style.display = "none";
}

// Thi·∫øt l·∫≠p event listeners khi trang t·∫£i xong
document.addEventListener("DOMContentLoaded", function() {
    // Event listener cho form th√™m c√¥ng vi·ªác
    const addJobForm = document.getElementById("addJobForm");
    if (addJobForm) {
        addJobForm.addEventListener("submit", function(e) {
            e.preventDefault();
            addJob();
        });
    }
    
    // Event listener cho form s·ª≠a c√¥ng vi·ªác
    const editJobForm = document.getElementById("editJobForm");
    if (editJobForm) {
        editJobForm.addEventListener("submit", function(e) {
            e.preventDefault();
            updateJob();
        });
    }
    
    // Event listener cho form th√™m ph√≤ng ban
    const addDepartmentForm = document.getElementById("addDepartmentForm");
    if (addDepartmentForm) {
        addDepartmentForm.addEventListener("submit", function(e) {
            e.preventDefault();
            addDepartment();
        });
    }
    
    // Event listener cho form s·ª≠a ph√≤ng ban
    const editDepartmentForm = document.getElementById("editDepartmentForm");
    if (editDepartmentForm) {
        editDepartmentForm.addEventListener("submit", function(e) {
            e.preventDefault();
            updateDepartment();
        });
    }
    
    // Hi·ªÉn th·ªã tab c√¥ng vi·ªác m·∫∑c ƒë·ªãnh khi t·∫£i trang
    showSection("jobs");
});
</script>
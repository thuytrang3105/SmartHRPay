<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qu·∫£n L√Ω Nh√¢n Vi√™n</title>
    <link rel="stylesheet" href="../static/employee_HR.css" />
  </head>
  <body>
    <!-- Sidebar -->
    <div class="sidebar">
      <h2>Trang Ch·ªß HR<br /></h2>
      <div class="menu-group">
        <h3>QU·∫¢N L√ù</h3>
        <ul>
          <li>
            <a href="employee_HR.html" class="active"><i>üë•</i> Nh√¢n vi√™n</a>
          </li>
          <li>
            <a href="depart_pos.html"><i>üëî</i> Ph√≤ng ban v√† c√¥ng vi·ªác</a>
          </li>
          <li>
            <a href="reports_HR.html"><i>üìà</i> B√°o c√°o nh√¢n s·ª± </a>
          </li>
        </ul>
      </div>
      <div class="menu-group">
        <h3>H·ªÜ TH·ªêNG</h3>
        <ul>
          <li>
            <a href="logout.html"><i>üö™</i> ƒêƒÉng xu·∫•t</a>
          </li>
        </ul>
      </div>
    </div>
    <!-- Main Content -->
    <div class="main-content">
      <div class="header">
        <h1>Qu·∫£n L√Ω Nh√¢n Vi√™n</h1>
        <div class="user-info">NGUY·ªÑN VƒÇN A <br />HR</div>
      </div>

      <div class="employee-table">
        <div class="table-header">
          <div class="search-container">
            <input
              type="text"
              class="search-bar"
              id="searchInput"
              placeholder="T√¨m ki·∫øm nh√¢n vi√™n..."
            />
            <button class="search-btn" onclick="searchEmployees()">
              T√¨m ki·∫øm
            </button>
          </div>
          <button class="add-btn" onclick="openAddModal()">
            Th√™m Nh√¢n Vi√™n
          </button>
        </div>
        <table id="employeeTable">
          <thead>
            <tr>
              <th>M√£ Nh√¢n Vi√™n</th>
              <th>H·ªç</th>
              <th>T√™n</th>
              <th>C√¥ng vi·ªác</th>
              <th>Ph√≤ng Ban</th>
              <th>Email</th>
              <th>Ng√†y V√†o L√†m</th>
              <th>L∆∞∆°ng C∆° B·∫£n</th>
              <th>Tr·∫°ng Th√°i</th>
              <th>H√†nh ƒê·ªông</th>
            </tr>
          </thead>
          <tbody id="employeeBody">
            <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Modal Th√™m Nh√¢n Vi√™n -->
    <div id="addEmployeeModal" class="modal">
      <div class="modal-content">
        <h2>Th√™m Nh√¢n Vi√™n</h2>
        <form id="addEmployeeForm">
          <label for="firstName">T√™n:</label>
          <input type="text" id="firstName" name="firstName" required />

          <label for="lastName">H·ªç:</label>
          <input type="text" id="lastName" name="lastName" required />

          <label for="email">Email:</label>
          <input type="email" id="email" name="email" required />

          <label for="phone">S·ªë ƒëi·ªán tho·∫°i:</label>
          <input type="tel" id="phone" name="phone" required />

          <label for="jobTitle">C√¥ng vi·ªác:</label>
          <input type="text" id="jobTitle" name="jobTitle" required />

          <label for="departmentName">Ph√≤ng ban:</label>
          <input
            type="text"
            id="departmentName"
            name="departmentName"
            required
          />

          <label for="hireDate">Ng√†y v√†o l√†m:</label>
          <input type="date" id="hireDate" name="hireDate" required />

          <label for="baseSalary">L∆∞∆°ng c∆° b·∫£n (VNƒê):</label>
          <input type="number" id="baseSalary" name="baseSalary" required />

          <div class="modal-buttons">
            <button type="button" class="cancel-btn" onclick="closeAddModal()">
              H·ªßy
            </button>
            <button type="submit" class="save-btn">L∆∞u</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Xem v√† Ch·ªânh S·ª≠a Nh√¢n Vi√™n -->
    <div id="viewEmployeeModal" class="modal">
      <div class="modal-content">
        <h2>Th√¥ng Tin Nh√¢n Vi√™n</h2>
        <table id="employeeDetailsTable">
          <tr>
            <th>M√£ Nh√¢n Vi√™n</th>
            <td><input type="text" id="editEmployeeId" disabled /></td>
          </tr>
          <tr>
            <th>H·ªç</th>
            <td><input type="text" id="editLastName" /></td>
          </tr>
          <tr>
            <th>T√™n</th>
            <td><input type="text" id="editFirstName" /></td>
          </tr>
          <tr>
            <th>Email</th>
            <td><input type="email" id="editEmail" /></td>
          </tr>
          <tr>
            <th>S·ªë ƒëi·ªán tho·∫°i</th>
            <td><input type="tel" id="editPhone" /></td>
          </tr>
          <tr>
            <th>Ng√†y v√†o l√†m</th>
            <td><input type="date" id="editHireDate" /></td>
          </tr>
          <tr>
            <th>Ph√≤ng ban</th>
            <td><input type="text" id="editDepartmentName" /></td>
          </tr>
          <tr>
            <th>C√¥ng vi·ªác</th>
            <td><input type="text" id="editJobTitle" /></td>
          </tr>
          <tr>
            <th>L∆∞∆°ng c∆° b·∫£n</th>
            <td><input type="number" id="editBaseSalary" /></td>
          </tr>
          <tr>
            <th>Tr·∫°ng th√°i</th>
            <td>
              <select id="editStatus">
                <option value="ƒêang l√†m vi·ªác">ƒêang l√†m vi·ªác</option>
                <option value="Ngh·ªâ vi·ªác">Ngh·ªâ vi·ªác</option>
              </select>
            </td>
          </tr>
        </table>
        <div class="modal-buttons">
          <button
            id="editButton"
            class="action-btn edit-btn"
            onclick="enableEditMode()"
          >
            Ch·ªânh s·ª≠a
          </button>
          <button class="action-btn close-btn" onclick="closeViewModal()">
            Tho√°t
          </button>
        </div>
      </div>
    </div>

    <script>
      // S·ª≠ d·ª•ng ƒë∆∞·ªùng d·∫´n t∆∞∆°ng ƒë·ªëi v√¨ HTML v√† API c√πng ngu·ªìn g·ªëc
      const API_URL = "/api/employees";

      // T·∫£i danh s√°ch nh√¢n vi√™n t·ª´ API khi trang ƒë∆∞·ª£c t·∫£i
      window.onload = function () {
        loadEmployees();
      };

      async function loadEmployees() {
        try {
          const response = await fetch(API_URL);
          if (!response.ok) {
            throw new Error(
              `Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ API. M√£ l·ªói: ${response.status}`
            );
          }
          const employees = await response.json();
          console.log("D·ªØ li·ªáu t·ª´ API:", employees); // Ki·ªÉm tra d·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c
          const tableBody = document.getElementById("employeeBody");
          tableBody.innerHTML = ""; // X√≥a d·ªØ li·ªáu c≈©
          employees.forEach((employee) => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${employee.employee_id}</td>
              <td>${employee.last_name}</td>
              <td>${employee.first_name}</td>
              <td>${employee.job_title}</td>
              <td>${employee.department_name}</td>
              <td>${employee.email}</td>
              <td>${employee.hire_date}</td>
              <td>${employee.base_salary.toLocaleString()}</td>
              <td>${employee.status}</td>
              <td>
                <button class="action-btn view-btn" onclick="viewEmployee('${
                  employee.employee_id
                }')">Xem</button>
                <button class="action-btn delete-btn" onclick="deleteEmployee('${
                  employee.employee_id
                }')">X√≥a</button>
              </td>
            `;
            tableBody.appendChild(row);
          });
        } catch (error) {
          console.error("L·ªói khi t·∫£i danh s√°ch nh√¢n vi√™n:", error);
          alert(
            "Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu nh√¢n vi√™n. Vui l√≤ng ki·ªÉm tra API ho·∫∑c k·∫øt n·ªëi."
          );
        }
      }

      // Xem th√¥ng tin nh√¢n vi√™n
      async function viewEmployee(employeeId) {
        try {
          const response = await fetch(`${API_URL}/${employeeId}`);
          if (!response.ok) {
            throw new Error(
              `Kh√¥ng th·ªÉ l·∫•y th√¥ng tin nh√¢n vi√™n. M√£ l·ªói: ${response.status}`
            );
          }
          const employee = await response.json();
          if (employee) {
            document.getElementById("editEmployeeId").value =
              employee.employee_id;
            document.getElementById("editLastName").value = employee.last_name;
            document.getElementById("editFirstName").value =
              employee.first_name;
            document.getElementById("editEmail").value = employee.email;
            document.getElementById("editPhone").value = employee.phone;
            document.getElementById("editHireDate").value = employee.hire_date;
            document.getElementById("editDepartmentName").value =
              employee.department_name;
            document.getElementById("editJobTitle").value = employee.job_title;
            document.getElementById("editBaseSalary").value =
              employee.base_salary;
            document.getElementById("editStatus").value = employee.status;

            // V√¥ hi·ªáu h√≥a c√°c tr∆∞·ªùng trong ch·∫ø ƒë·ªô xem
            const inputs = document.querySelectorAll(
              "#employeeDetailsTable input, #employeeDetailsTable select"
            );
            inputs.forEach((input) => {
              if (input.id !== "editEmployeeId") input.disabled = true;
            });

            document.querySelector(".modal-buttons").innerHTML = `
              <button id="editButton" class="action-btn edit-btn" onclick="enableEditMode()">Ch·ªânh s·ª≠a</button>
              <button class="action-btn close-btn" onclick="closeViewModal()">Tho√°t</button>
            `;

            document.getElementById("viewEmployeeModal").style.display = "flex";
          }
        } catch (error) {
          console.error("L·ªói khi xem th√¥ng tin nh√¢n vi√™n:", error);
          alert(
            "Kh√¥ng th·ªÉ xem th√¥ng tin nh√¢n vi√™n. Vui l√≤ng ki·ªÉm tra API ho·∫∑c k·∫øt n·ªëi."
          );
        }
      }

      // K√≠ch ho·∫°t ch·∫ø ƒë·ªô ch·ªânh s·ª≠a
      function enableEditMode() {
        const inputs = document.querySelectorAll(
          "#employeeDetailsTable input, #employeeDetailsTable select"
        );
        inputs.forEach((input) => {
          if (input.id !== "editEmployeeId") input.disabled = false;
        });

        document.querySelector(".modal-buttons").innerHTML = `
          <button class="action-btn save-btn" onclick="saveEmployee()">L∆∞u</button>
          <button class="action-btn cancel-btn" onclick="cancelEdit()">H·ªßy</button>
        `;
      }

      // L∆∞u thay ƒë·ªïi nh√¢n vi√™n
      async function saveEmployee() {
        const employeeId = document.getElementById("editEmployeeId").value;
        const updatedEmployee = {
          first_name: document.getElementById("editFirstName").value,
          last_name: document.getElementById("editLastName").value,
          email: document.getElementById("editEmail").value,
          phone: document.getElementById("editPhone").value,
          hire_date: document.getElementById("editHireDate").value,
          department_name: document.getElementById("editDepartmentName").value,
          job_title: document.getElementById("editJobTitle").value,
          base_salary: parseInt(
            document.getElementById("editBaseSalary").value
          ),
          status: document.getElementById("editStatus").value,
        };

        try {
          const response = await fetch(`${API_URL}/${employeeId}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(updatedEmployee),
          });
          if (response.ok) {
            loadEmployees();
            viewEmployee(employeeId); // T·∫£i l·∫°i ch·∫ø ƒë·ªô xem
          } else {
            console.error("L·ªói khi c·∫≠p nh·∫≠t nh√¢n vi√™n");
            alert("Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t nh√¢n vi√™n. Vui l√≤ng th·ª≠ l·∫°i.");
          }
        } catch (error) {
          console.error("L·ªói khi c·∫≠p nh·∫≠t nh√¢n vi√™n:", error);
          alert(
            "Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t nh√¢n vi√™n. Vui l√≤ng ki·ªÉm tra API ho·∫∑c k·∫øt n·ªëi."
          );
        }
      }

      // H·ªßy ch·ªânh s·ª≠a
      function cancelEdit() {
        const employeeId = document.getElementById("editEmployeeId").value;
        viewEmployee(employeeId); // Quay l·∫°i ch·∫ø ƒë·ªô xem
      }

      // ƒê√≥ng modal xem
      function closeViewModal() {
        document.getElementById("viewEmployeeModal").style.display = "none";
      }

      // M·ªü modal th√™m nh√¢n vi√™n
      function openAddModal() {
        document.getElementById("addEmployeeModal").style.display = "flex";
      }

      // ƒê√≥ng modal th√™m nh√¢n vi√™n
      function closeAddModal() {
        document.getElementById("addEmployeeModal").style.display = "none";
        document.getElementById("addEmployeeForm").reset();
      }

      // Th√™m nh√¢n vi√™n m·ªõi
      document
        .getElementById("addEmployeeForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          const newEmployee = {
            first_name: document.getElementById("firstName").value,
            last_name: document.getElementById("lastName").value,
            email: document.getElementById("email").value,
            phone: document.getElementById("phone").value,
            hire_date: document.getElementById("hireDate").value,
            department_name: document.getElementById("departmentName").value,
            job_title: document.getElementById("jobTitle").value,
            base_salary: parseInt(document.getElementById("baseSalary").value),
            status: "ƒêang l√†m vi·ªác",
          };

          try {
            const response = await fetch(API_URL, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(newEmployee),
            });
            if (response.ok) {
              loadEmployees();
              closeAddModal();
            } else {
              console.error("L·ªói khi th√™m nh√¢n vi√™n");
              alert("Kh√¥ng th·ªÉ th√™m nh√¢n vi√™n. Vui l√≤ng th·ª≠ l·∫°i.");
            }
          } catch (error) {
            console.error("L·ªói khi th√™m nh√¢n vi√™n:", error);
            alert(
              "Kh√¥ng th·ªÉ th√™m nh√¢n vi√™n. Vui l√≤ng ki·ªÉm tra API ho·∫∑c k·∫øt n·ªëi."
            );
          }
        });

      // X√≥a nh√¢n vi√™n
      async function deleteEmployee(employeeId) {
        if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a nh√¢n vi√™n ${employeeId}?`)) {
          try {
            const response = await fetch(`${API_URL}/${employeeId}`, {
              method: "DELETE",
            });
            if (response.ok) {
              loadEmployees();
            } else {
              console.error("L·ªói khi x√≥a nh√¢n vi√™n");
              alert("Kh√¥ng th·ªÉ x√≥a nh√¢n vi√™n. Vui l√≤ng th·ª≠ l·∫°i.");
            }
          } catch (error) {
            console.error("L·ªói khi x√≥a nh√¢n vi√™n:", error);
            alert(
              "Kh√¥ng th·ªÉ x√≥a nh√¢n vi√™n. Vui l√≤ng ki·ªÉm tra API ho·∫∑c k·∫øt n·ªëi."
            );
          }
        }
      }

      // T√¨m ki·∫øm nh√¢n vi√™n
      function searchEmployees() {
        const input = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const rows = document.querySelectorAll("#employeeBody tr");
        rows.forEach((row) => {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(input) ? "" : "none";
        });
      }
    </script>
  </body>
</html>

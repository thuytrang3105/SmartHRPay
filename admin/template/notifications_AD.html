<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qu·∫£n L√Ω Th√¥ng B√°o</title>
    <link rel="stylesheet" href="../static/notifications_AD.css" />
  </head>
  <body>
    <!-- Sidebar -->
    <div class="sidebar">
      <h2>Trang Ch·ªß Admin<br /></h2>

      <div class="menu-group">
        <h3>T·ªîNG QUAN</h3>
        <ul>
          <li>
            <a href="dashboard_AD.html"><i>üìä</i> Dashboard</a>
          </li>
        </ul>
      </div>

      <div class="menu-group">
        <h3>QU·∫¢N L√ù</h3>
        <ul>
          <li>
            <a href="home_HR.html"><i>üë•</i> Nh√¢n vi√™n</a>
          </li>
          <li>
            <a href="home_AC.html"><i>üí∞</i> L∆∞∆°ng</a>
          </li>
          <li>
            <a href="user_roles_AD.html"><i>üè¢</i> Ph√¢n quy·ªÅn ng∆∞·ªùi d√πng</a>
          </li>
          <li>
            <a href="update_user_role.html"
              ><i>üîë</i> C·∫≠p nh·∫≠t quy·ªÅn ng∆∞·ªùi d√πng</a
            >
          </li>
          <li>
            <a href="notifications_AD.html" class="active"
              ><i>üì¢</i> Qu·∫£n l√Ω th√¥ng b√°o</a
            >
          </li>
        </ul>
      </div>

      <div class="menu-group">
        <h3>B√ÅO C√ÅO</h3>
        <ul>
          <li>
            <a href="reports_AD.html"><i>üìà</i> B√°o c√°o nh√¢n s·ª±</a>
          </li>
          <li>
            <a href="activity_log_AD.html"><i>üìú</i> L·ªãch s·ª≠ ho·∫°t ƒë·ªông</a>
          </li>
        </ul>
      </div>

      <div class="menu-group">
        <h3>H·ªÜ TH·ªêNG</h3>
        <ul>
          <li>
            <a href="logout.html"><i>üö™</i> ƒêƒÉng xu·∫•t</a>
          </li>
        </ul>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <div class="header">
        <h1>H·ªá th·ªëng Qu·∫£n l√Ω L∆∞∆°ng</h1>
        <div class="user-info">NGUY·ªÑN VƒÇN B<br />ADMIN</div>
      </div>

      <!-- Notification List -->
      <div class="notification-container">
        <div class="tabs">
          <a href="#" class="active">T·∫•t c·∫£ th√¥ng b√°o</a>
          <a href="#">ƒê√£ g·ª≠i</a>
          <a href="#">L∆∞u nh√°p</a>
        </div>
        <a href="#" class="create-btn">T·∫°o th√¥ng b√°o m·ªõi</a>
        <div id="notificationList">
          <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
        </div>
      </div>

      <!-- Modal for Details -->
      <div id="detailsModal" class="modal">
        <div class="modal-content">
          <span class="close" onclick="closeModal('detailsModal')"
            >&times;</span
          >
          <h2>Chi ti·∫øt Th√¥ng b√°o</h2>
          <div class="form-group">
            <label>Ti√™u ƒë·ªÅ</label>
            <p id="detailsMessage"></p>
          </div>
          <div class="form-group">
            <label>G·ª≠i ƒë·∫øn</label>
            <p id="detailsRecipient"></p>
          </div>
          <div class="form-group">
            <label>T·∫°o l√∫c</label>
            <p id="detailsCreatedAt"></p>
          </div>
          <div class="form-group">
            <label>Tr·∫°ng th√°i</label>
            <p id="detailsStatus"></p>
          </div>
        </div>
      </div>

      <!-- Modal for Edit -->
      <div id="editModal" class="modal">
        <div class="modal-content">
          <span class="close" onclick="closeModal('editModal')">&times;</span>
          <h2>Ch·ªânh s·ª≠a Th√¥ng b√°o</h2>
          <div class="form-group">
            <label>Ti√™u ƒë·ªÅ</label>
            <textarea id="editMessage"></textarea>
          </div>
          <div class="form-group">
            <label>G·ª≠i ƒë·∫øn</label>
            <input type="text" id="editRecipient" />
          </div>
          <button class="save-btn" onclick="saveNotification()">L∆∞u</button>
          <div id="editMessage" class="message"></div>
        </div>
      </div>
    </div>

    <script>
      let currentNotificationId = null;

      // H√†m l·∫•y danh s√°ch th√¥ng b√°o t·ª´ API
      async function fetchNotifications() {
        try {
          const response = await fetch("http://localhost:5000/notifications");
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          const data = await response.json();

          const notificationList = document.getElementById("notificationList");
          notificationList.innerHTML = ""; // X√≥a d·ªØ li·ªáu c≈©

          // Th√™m d·ªØ li·ªáu v√†o danh s√°ch
          data.forEach((notification) => {
            const item = document.createElement("div");
            item.className = "notification-item";
            item.innerHTML = `
                        <h3>${notification.message}</h3>
                        <p>G·ª≠i ƒë·∫øn: ${notification.recipient}</p>
                        <div class="meta">T·∫°o l√∫c: ${
                          notification.created_at
                        }</div>
                        <div class="actions">
                            ${
                              notification.status === "sent"
                                ? '<span class="sent">ƒê√£ g·ª≠i</span>'
                                : '<span class="draft">L∆∞u nh√°p</span>'
                            }
                            <a href="#" class="details" onclick="showDetails(${
                              notification.id
                            }, '${notification.message}', '${
              notification.recipient
            }', '${notification.created_at}', '${
              notification.status
            }')">Chi ti·∫øt</a>
                            ${
                              notification.status === "sent"
                                ? `<a href="#" class="resend" onclick="resendNotification(${notification.id})">G·ª≠i l·∫°i</a>`
                                : `<a href="#" class="edit" onclick="showEdit(${notification.id}, '${notification.message}', '${notification.recipient}')">Ch·ªânh s·ª≠a</a>`
                            }
                        </div>
                    `;
            notificationList.appendChild(item);
          });
        } catch (error) {
          console.error("L·ªói khi l·∫•y danh s√°ch th√¥ng b√°o:", error);
          const notificationList = document.getElementById("notificationList");
          notificationList.innerHTML =
            "<p>Kh√¥ng th·ªÉ t·∫£i th√¥ng b√°o. Vui l√≤ng th·ª≠ l·∫°i sau.</p>";
        }
      }

      // H√†m hi·ªÉn th·ªã chi ti·∫øt th√¥ng b√°o
      function showDetails(id, message, recipient, createdAt, status) {
        document.getElementById("detailsMessage").textContent = message;
        document.getElementById("detailsRecipient").textContent = recipient;
        document.getElementById("detailsCreatedAt").textContent = createdAt;
        document.getElementById("detailsStatus").textContent = status;
        document.getElementById("detailsModal").style.display = "block";
      }

      // H√†m hi·ªÉn th·ªã form ch·ªânh s·ª≠a
      function showEdit(id, message, recipient) {
        currentNotificationId = id;
        document.getElementById("editMessage").value = message;
        document.getElementById("editRecipient").value = recipient;
        document.getElementById("editModal").style.display = "block";
      }

      // H√†m g·ª≠i l·∫°i th√¥ng b√°o
      async function resendNotification(id) {
        try {
          const response = await fetch(
            `http://localhost:5000/notifications/resend/${id}`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
            }
          );
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          const data = await response.json();
          alert(data.message);
          fetchNotifications(); // L√†m m·ªõi danh s√°ch
        } catch (error) {
          console.error("L·ªói khi g·ª≠i l·∫°i th√¥ng b√°o:", error);
          alert("Kh√¥ng th·ªÉ g·ª≠i l·∫°i th√¥ng b√°o. Vui l√≤ng th·ª≠ l·∫°i sau.");
        }
      }

      // H√†m l∆∞u th√¥ng b√°o ƒë√£ ch·ªânh s·ª≠a
      async function saveNotification() {
        const message = document.getElementById("editMessage").value;
        const recipient = document.getElementById("editRecipient").value;

        try {
          const response = await fetch(
            `http://localhost:5000/notifications/update/${currentNotificationId}`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ message, recipient }),
            }
          );
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          const data = await response.json();
          showMessage("editMessage", data.message, "success");
          closeModal("editModal");
          fetchNotifications(); // L√†m m·ªõi danh s√°ch
        } catch (error) {
          console.error("L·ªói khi l∆∞u th√¥ng b√°o:", error);
          showMessage(
            "editMessage",
            "Kh√¥ng th·ªÉ l∆∞u th√¥ng b√°o. Vui l√≤ng th·ª≠ l·∫°i sau.",
            "error"
          );
        }
      }

      // H√†m ƒë√≥ng modal
      function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
      }

      // H√†m hi·ªÉn th·ªã th√¥ng b√°o
      function showMessage(elementId, text, type) {
        const messageDiv = document.getElementById(elementId);
        messageDiv.textContent = text;
        messageDiv.className = `message ${type}`;
        messageDiv.style.display = "block";

        // ·∫®n th√¥ng b√°o sau 5 gi√¢y
        setTimeout(() => {
          messageDiv.style.display = "none";
        }, 5000);
      }

      // G·ªçi h√†m l·∫•y d·ªØ li·ªáu khi trang ƒë∆∞·ª£c t·∫£i
      fetchNotifications();
    </script>
  </body>
</html>
